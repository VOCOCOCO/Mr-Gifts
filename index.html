<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Gifts Cases ‚Äî Home / Upgrade / Inventory</title>

  <!-- Telegram WebApp SDK (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –≤–Ω—É—Ç—Ä–∏ Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- GSAP (–∞–Ω–∏–º–∞—Ü–∏–∏) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <style>
    :root{
      --bg0:#06080d;
      --bg1:#0a0f1b;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(74,163,255,.22);

      --text:#eef5ff;
      --muted:#a7b8d9;

      --blue:#4aa3ff;
      --blue2:#2b7bff;
      --green:#25e39a;
      --red:#ff4a6a;
      --gold:#ffd56a;

      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r: 18px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color:var(--text);
      background:
        radial-gradient(900px 520px at 70% -10%, rgba(74,163,255,.10), transparent 60%),
        radial-gradient(800px 520px at 20% 0%, rgba(130,90,255,.08), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    /* App layout */
    .app{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      padding-top: var(--safeTop);
    }

    .topbar{
      padding: 14px 16px 10px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      cursor:pointer;
      user-select:none;
    }
    .titleWrap{flex:1; min-width:0}
    .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1.1;
      margin:0;
    }
    .subtitle{
      margin:2px 0 0;
      font-size:12px;
      color:rgba(255,255,255,.55);
    }
    .wallet{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 9px 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .plus{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(43,123,255,.95));
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.22);
      cursor:pointer;
    }
    .balance{
      font-weight:900; font-size:14px;
      display:flex; align-items:center; gap:6px;
      min-width:76px; justify-content:flex-end;
    }
    .star{filter: drop-shadow(0 6px 16px rgba(255,213,106,.25))}
    .star::before{content:"‚òÖ"; color:var(--gold); font-size:16px}

    .content{
      flex:1;
      overflow:auto;
      padding: 6px 14px 96px;
      -webkit-overflow-scrolling: touch;
    }

    /* section headers */
    .sectionTitle{
      margin: 12px 4px 10px;
      text-transform:uppercase;
      letter-spacing:1.3px;
      font-weight:950;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      text-align:center;
    }

    /* layout helpers */
    .panel{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 24px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .note{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      line-height:1.35;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .sep{height:10px}

    /* Bottom nav (Telegram-like sliding pill) */
    .nav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(10,12,18,0), rgba(10,12,18,.65) 25%, rgba(10,12,18,.88));
      backdrop-filter: blur(14px);
      z-index:50;
    }
    .navBar{
      height: 62px;
      border-radius: 20px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      display:flex;
      overflow:hidden;
      position:relative;
    }
    .navPill{
      position:absolute;
      top:8px; bottom:8px;
      left:8px;
      width:calc((100% - 16px) / 3);
      border-radius: 16px;
      background: radial-gradient(120px 60px at 50% 0%, rgba(74,163,255,.42), rgba(74,163,255,.14));
      border:1px solid rgba(74,163,255,.30);
      box-shadow: 0 18px 45px rgba(43,123,255,.18);
      z-index:0;
      transform: translateX(0);
    }
    .tabBtn{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      color: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:1;
    }
    .tabBtn svg{width:22px;height:22px}
    .tabBtn.active{
      color: rgba(255,255,255,.95);
    }

    /* Pages */
    .page{display:none}
    .page.active{display:block}

    /* ===== CASES GRID (closer to your refs: 2 in row, more cases, —Ä–æ–≤–Ω–æ) ===== */
    .casesGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .caseCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      cursor:pointer;
      position:relative;
      min-height: 220px;
      transform: translateZ(0);
    }
    .caseCard.big{ grid-column: span 2; min-height: 210px; }

    .badge{
      position:absolute;
      top:10px; left:10px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding: 6px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight:950;
      letter-spacing:.6px;
      z-index:3;
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:7px;
      color: rgba(255,255,255,.92);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(74,163,255,.95);
      box-shadow: 0 0 0 4px rgba(74,163,255,.10);
    }

    .caseHero{
      height: 142px;
      display:grid; place-items:center;
      position:relative;
      padding: 14px;
    }
    .caseCard.big .caseHero{ height: 150px; }
    .caseAvatar{
      width: 100%;
      height: 100%;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .caseAvatar img{
      width:100%; height:100%; object-fit:cover;
      display:block;
    }
    .caseAvatar .fallback{
      font-size: 52px;
      color: rgba(255,255,255,.92);
      filter: drop-shadow(0 14px 30px rgba(0,0,0,.45));
    }

    .caseMeta{
      padding: 10px 14px 14px;
      position:relative;
      z-index:2;
    }
    .caseName{
      font-weight:950;
      font-size: 14px;
      margin: 0 0 8px;
      color: rgba(255,255,255,.92);
      min-height: 36px;
      line-height:1.15;
    }
    .priceRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:950;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .priceRow .left{
      display:flex; align-items:center; gap:8px;
    }
    .miniTag{
      font-size:11px;
      font-weight:950;
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.80);
    }

    /* ===== MODAL ===== */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding: 12px 12px calc(12px + var(--safeBottom));
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
      transform: translateY(12px);
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHead .h{
      font-weight:950;
      letter-spacing:1.1px;
      text-transform:uppercase;
      color: rgba(255,255,255,.84);
      font-size: 13px;
    }
    .xbtn{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }

    .casePreview{
      padding: 12px 14px 0;
      text-align:center;
    }
    .bigImg{
      width: 100%;
      height: 190px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      display:grid; place-items:center;
    }
    .bigImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .bigImg .fallback{font-size:76px; filter: drop-shadow(0 18px 45px rgba(0,0,0,.55));}
    .casePreview .name{
      margin: 12px 0 0;
      font-weight:950;
      font-size: 18px;
    }
    .casePreview .desc{
      margin: 6px 0 0;
      color: rgba(255,255,255,.65);
      font-size: 13px;
      line-height:1.35;
    }

    .chooser{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .pillRow{
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      color: rgba(255,255,255,.85);
      font-weight:950;
      font-size:13px;
    }
    .countPills{
      display:flex;
      gap:10px;
      justify-content:space-between;
    }
    .pill{
      flex:1;
      height: 44px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      color: rgba(255,255,255,.78);
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      background: radial-gradient(120px 70px at 50% 0%, rgba(74,163,255,.42), rgba(74,163,255,.14));
      border:1px solid rgba(74,163,255,.28);
      color: rgba(255,255,255,.95);
      box-shadow: 0 14px 40px rgba(43,123,255,.18);
    }

    .btn{
      width:100%;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(43,123,255,.95));
      color:#fff;
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(43,123,255,.22);
    }
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
      color: rgba(255,255,255,.90);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    /* ===== ROULETTE (–±–µ–∑ —Å–ø–µ—Ü-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö) ===== */
    .rouletteWrap{
      margin: 0 14px 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
    }
    .rouletteTop{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.78);
      font-weight:950;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size: 12px;
    }
    .track{
      position:relative;
      height: 120px;
      overflow:hidden;
      background: rgba(0,0,0,.12);
    }
    .centerLine{
      position:absolute;
      top:10px; bottom:10px;
      left:50%;
      width: 3px;
      transform: translateX(-50%);
      background: rgba(74,163,255,.65);
      box-shadow: 0 0 0 6px rgba(74,163,255,.08);
      border-radius: 99px;
      z-index:5;
    }
    .reel{
      position:absolute;
      left:0; top:0;
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 14px;
      will-change: transform;
    }
    .itemChip{
      width: 104px;
      height: 92px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:7px;
      flex: 0 0 auto;
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .chipImg{
      width:42px; height:42px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .chipImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .chipImg .fallback{font-size:24px}
    .itemChip .n{
      font-size: 11px;
      font-weight:950;
      color: rgba(255,255,255,.85);
      text-align:center;
      padding: 0 6px;
      line-height:1.05;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .resultToast{
      margin: 0 14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .resultToast.show{display:flex}
    .resultLeft{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .resImg{
      width:44px;height:44px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .resImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .resImg .fallback{font-size:26px}
    .resultLeft .t{
      display:flex; flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .resultLeft .t b{font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .resultLeft .t span{font-size:12px; color:rgba(255,255,255,.65); display:flex; align-items:center; gap:6px}
    .tagWin{
      padding: 7px 10px;
      border-radius: 999px;
      font-weight:950;
      font-size: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      display:flex; align-items:center; gap:7px;
      white-space:nowrap;
    }
    .tagWin.good{border-color: rgba(37,227,154,.30); background: rgba(37,227,154,.10)}
    .tagWin.bad{border-color: rgba(255,74,106,.28); background: rgba(255,74,106,.10)}

    /* ===== INVENTORY: 2 –≤ —Ä—è–¥ + Sell/Withdraw ===== */
    .invGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    .giftCard{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 12px 35px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 210px;
    }
    .giftTop{
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .giftQty{
      font-weight:950;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
      min-width: 56px;
      text-align:center;
      font-size: 12px;
    }
    .giftImg{
      margin: 0 12px 10px;
      height: 96px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .giftImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .giftImg .fallback{font-size:44px}
    .giftMeta{
      padding: 0 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .giftName{
      font-weight:950;
      font-size: 12.5px;
      line-height:1.15;
      color: rgba(255,255,255,.92);
      min-height: 30px;
    }
    .giftPrice{
      display:flex; align-items:center; gap:8px;
      font-weight:950;
      color: rgba(255,255,255,.86);
      font-size: 12px;
    }
    .giftActions{
      margin-top:auto;
      padding: 12px;
      display:flex;
      gap:10px;
    }
    .btnSmall{
      flex:1;
      height: 40px;
      border-radius: 14px;
      font-weight:950;
      font-size: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .btnSmall.primary{
      background: rgba(74,163,255,.18);
      border-color: rgba(74,163,255,.22);
    }
    .btnSmall:active{transform: translateY(1px)}

    /* ===== UPGRADE ===== */
    .upgradeTitle{
      text-align:center;
      font-weight:950;
      letter-spacing:1.4px;
      text-transform:uppercase;
      color: rgba(255,255,255,.78);
      margin: 6px 0 14px;
      font-size: 13px;
    }
    .slots{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .slot{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 12px;
      min-height: 140px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .slot .label{
      font-size: 11px;
      font-weight:950;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .miniBtn{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.85);
      font-weight:950;
      font-size: 11px;
      cursor:pointer;
      user-select:none;
    }
    .pick{
      margin-top:auto;
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .pick .pImg{
      width:44px;height:44px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .pick .pImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .pick .pImg .fallback{font-size:24px}
    .pick .info{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .pick .info b{
      font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pick .info span{
      font-size: 12px; color: rgba(255,255,255,.65);
      display:flex; align-items:center; gap:6px;
      white-space:nowrap;
    }

    .upgradeMid{
      margin: 12px 0 0;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }

    /* –∫—Ä—É–≥ + —Å—Ç—Ä–µ–ª–∫–∞ */
    .dial{
      width: 150px; height: 150px;
      position:relative;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .dialRing{
      position:absolute; inset:10px;
      border-radius: 999px;
      border:10px solid rgba(255,255,255,.06);
    }
    .dialArc{
      position:absolute; inset:10px;
      border-radius: 999px;
      border:10px solid rgba(74,163,255,.22);
      clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%);
      opacity:.8;
    }
    .dialCenter{
      position:absolute;
      width:74px; height:74px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      text-align:center;
      padding: 8px;
    }
    .dialCenter b{font-size: 16px}
    .dialCenter span{
      margin-top:2px;
      font-size: 10.5px;
      color: rgba(255,255,255,.62);
      font-weight:950;
      letter-spacing:1.2px;
      text-transform:uppercase
    }
    .arrowWrap{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
    }
    .arrow{
      width: 8px;
      height: 60px;
      border-radius: 999px;
      background: rgba(255,255,255,.90);
      box-shadow: 0 12px 22px rgba(0,0,0,.35);
      transform-origin: 50% 85%;
      transform: rotate(0deg) translateY(-26px);
      position:relative;
    }
    .arrow::after{
      content:"";
      position:absolute;
      top:-10px; left:50%;
      transform: translateX(-50%);
      width: 0; height:0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 14px solid rgba(255,255,255,.95);
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.25));
    }

    .upgradeControls{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Picker sheet */
    .sheetOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:110;
      padding: 12px 12px calc(12px + var(--safeBottom));
    }
    .sheetOverlay.show{display:flex}
    .sheet{
      width:min(520px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .sheetHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheetHead b{
      font-size: 13px;
      font-weight:950;
      letter-spacing:1.1px;
      text-transform:uppercase;
      color: rgba(255,255,255,.82);
    }
    .sheetBody{
      max-height: 55vh;
      overflow:auto;
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .pickCard{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height: 120px;
    }
    .pickCard .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pickCard .pImg{
      width:40px;height:40px;border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .pickCard .pImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .pickCard .pImg .fallback{font-size:22px}
    .pickCard .nm{font-weight:950; font-size:12px; line-height:1.1; color:rgba(255,255,255,.92)}
    .pickCard .pr{font-weight:950; font-size:12px; color:rgba(255,255,255,.80); display:flex; align-items:center; gap:6px}
    .pickCard .sub{font-size:11px; color:rgba(255,255,255,.60)}
    .pickCard:active{transform: translateY(1px)}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(88px + var(--safeBottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      display:none;
      z-index:200;
      font-weight:900;
      font-size: 13px;
      max-width: min(520px, calc(100% - 24px));
      text-align:center;
    }
    .toast.show{display:block}

    /* Responsive */
    @media (min-width: 560px){
      .content{padding-left: 18px; padding-right:18px}
      .casesGrid{gap:14px}
      .invGrid{gap:14px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="back" id="btnBack" title="–ù–∞–∑–∞–¥">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M14.5 6L8.5 12l6 6" stroke="rgba(255,255,255,.9)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="titleWrap">
        <p class="title">Gifts Battle</p>
        <p class="subtitle">mini app demo</p>
      </div>

      <div class="wallet">
        <div class="plus" id="btnAddStars" title="–ü–æ–ø–æ–ª–Ω–∏—Ç—å (–¥–µ–º–æ)">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="balance"><span class="star"></span><span id="starsValue">0</span></div>
      </div>
    </div>

    <div class="content" id="scrollArea">
      <!-- HOME -->
      <div class="page active" id="pageHome">
        <div class="sectionTitle">LIMITED CASES</div>
        <div class="casesGrid" id="casesGrid"></div>

        <div class="sep"></div>

        <div class="panel">
          <div class="note">
            ‚úÖ –í—Å—Ç–∞–≤–ª—è–π —Å–≤–æ–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏:
            <br>- –∫–µ–π—Å—ã: <b>cases[i].img</b>
            <br>- –ø–æ–¥–∞—Ä–∫–∏: <b>gifts[i].img</b>
            <br><br>
            ‚öôÔ∏è –í—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ <b>localStorage</b>. ‚Äú–ü–æ–¥–∫—Ä—É—Ç–∫–∞‚Äù —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞: –≤ –∫–µ–π—Å–∞—Ö —á–∞—â–µ –ø–∞–¥–∞—é—Ç –¥–µ—à—ë–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏,
            –∞ –≤ –∞–ø–≥—Ä–µ–π–¥–µ —à–∞–Ω—Å —á—É—Ç—å –Ω–∏–∂–µ –±–∞–∑–æ–≤–æ–≥–æ.
          </div>
          <div class="sep"></div>
          <button class="btn ghost" id="btnDemoFill">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (–¥–µ–º–æ)</button>
        </div>
      </div>

      <!-- UPGRADE -->
      <div class="page" id="pageUpgrade">
        <div class="sectionTitle">UPGRADE</div>

        <div class="panel">
          <div class="upgradeTitle">–ê–ø–≥—Ä–µ–π–¥</div>

          <div class="slots">
            <div class="slot" id="slotFrom">
              <div class="label">
                <span>–ß—Ç–æ –∞–ø–≥—Ä–µ–π–¥–∏–º</span>
                <span class="miniBtn" id="pickFromBtn">–í—ã–±—Ä–∞—Ç—å</span>
              </div>
              <div class="pick" id="fromPick"></div>
            </div>

            <div class="slot" id="slotTo">
              <div class="label">
                <span>–¶–µ–ª—å</span>
                <span class="miniBtn" id="pickToBtn">–í—ã–±—Ä–∞—Ç—å</span>
              </div>
              <div class="pick" id="toPick"></div>
            </div>
          </div>

          <div class="upgradeMid">
            <div class="dial" aria-label="–®–∞–Ω—Å + —Å—Ç—Ä–µ–ª–∫–∞">
              <div class="dialRing"></div>
              <div class="dialArc" id="dialArc"></div>

              <div class="arrowWrap">
                <div class="arrow" id="dialArrow"></div>
              </div>

              <div class="dialCenter">
                <b id="chanceText">0%</b>
                <span>chance</span>
              </div>
            </div>

            <div class="upgradeControls">
              <div class="note" id="upgradeHint">
                –í—ã–±–µ—Ä–∏ <b>–∏—Å—Ö–æ–¥–Ω—ã–π</b> –ø–æ–¥–∞—Ä–æ–∫ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏ <b>—Ü–µ–ª—å</b> ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —à–∞–Ω—Å –∏ –∫–Ω–æ–ø–∫–∞.
              </div>
              <button class="btn" id="btnUpgrade" disabled>–ê–ø–≥—Ä–µ–π–¥</button>
              <button class="btn ghost" id="btnResetUpgrade">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
          </div>

          <div class="sep"></div>
          <div class="note" id="upgradeResultNote" style="display:none;"></div>
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="page" id="pageInv">
        <div class="sectionTitle">INVENTORY</div>

        <div class="panel">
          <div class="note">
            –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <b>2 –ø–æ–¥–∞—Ä–∫–∞ –≤ —Ä—è–¥</b>. –ú–æ–∂–Ω–æ ‚Äú–ü—Ä–æ–¥–∞—Ç—å‚Äù (–¥–µ–º–æ: –¥–∞—ë—Ç ‚òÖ), –ª–∏–±–æ ‚Äú–í—ã–≤–µ—Å—Ç–∏‚Äù (–¥–µ–º–æ: –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ).
          </div>
          <div class="sep"></div>

          <div class="invGrid" id="invGrid"></div>

          <div class="sep"></div>
          <button class="btn ghost" id="btnClearInv">–û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        </div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <div class="nav">
      <div class="navBar" id="navBar">
        <div class="navPill" id="navPill"></div>

        <div class="tabBtn active" data-tab="home" data-index="0">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 11.2 12 4l8 7.2V20a1.8 1.8 0 0 1-1.8 1.8H5.8A1.8 1.8 0 0 1 4 20v-8.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9.5 21v-7.2h5V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          –î–æ–º
        </div>

        <div class="tabBtn" data-tab="upgrade" data-index="1">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 2.8l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4-5.8-3.1-5.8 3.1 1.1-6.4-4.7-4.6 6.5-.9L12 2.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          –ê–ø–≥—Ä–µ–π–¥
        </div>

        <div class="tabBtn" data-tab="inv" data-index="2">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 7.5h12l-1 13.2a1.7 1.7 0 0 1-1.7 1.6H8.7A1.7 1.7 0 0 1 7 20.7L6 7.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9 7.5V6a3 3 0 0 1 6 0v1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
        </div>
      </div>
    </div>
  </div>

  <!-- Case Modal -->
  <div class="modalOverlay" id="caseModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="h" id="modalHeader">CASE</div>
        <div class="xbtn" id="closeModal">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="casePreview">
        <div class="bigImg" id="modalBigImg"></div>
        <div class="name" id="modalName">CASE</div>
        <div class="desc" id="modalDesc">–û—Ç–∫—Ä–æ–π –∫–µ–π—Å ‚Äî –ø–æ–ª—É—á–∏ –ø–æ–¥–∞—Ä–æ–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
      </div>

      <div class="chooser">
        <div class="pillRow">
          <div>How many cases?</div>
          <div style="display:flex; align-items:center; gap:6px; color:rgba(255,255,255,.8)">
            <span class="star"></span><span id="modalPrice">0</span>
          </div>
        </div>

        <div class="countPills" id="countPills">
          <div class="pill active" data-n="1">1</div>
          <div class="pill" data-n="2">2</div>
          <div class="pill" data-n="3">3</div>
          <div class="pill" data-n="4">4</div>
          <div class="pill" data-n="5">5</div>
        </div>
      </div>

      <div class="rouletteWrap">
        <div class="rouletteTop">
          <span>roulette</span>
          <span style="color:rgba(255,255,255,.65)" id="rouletteHint">–ù–∞–∂–º–∏ ‚ÄúOpen case‚Äù</span>
        </div>
        <div class="track">
          <div class="centerLine"></div>
          <div class="reel" id="reel"></div>
        </div>
      </div>

      <div class="resultToast" id="resultToast">
        <div class="resultLeft">
          <div class="resImg" id="resImg"></div>
          <div class="t">
            <b id="resName">Gift</b>
            <span><span class="star"></span><span id="resValue">0</span> ‚Ä¢ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
          </div>
        </div>
        <div class="tagWin good" id="resTag"><span>‚úî</span><span>WIN</span></div>
      </div>

      <div style="padding: 0 14px 14px;">
        <button class="btn" id="btnOpenCase"><span>Open case</span> <span class="star"></span><span id="btnCost">0</span></button>
        <div class="sep"></div>
        <button class="btn ghost" id="btnShowContents">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ</button>
      </div>
    </div>
  </div>

  <!-- Picker Sheet -->
  <div class="sheetOverlay" id="pickerOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <b id="pickerTitle">–í—ã–±–µ—Ä–∏ –ø–æ–¥–∞—Ä–æ–∫</b>
        <div class="xbtn" id="pickerClose">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
      <div class="sheetBody" id="pickerBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

  <script>
    /********************
     * Telegram init
     ********************/
    const tg = window.Telegram?.WebApp;
    try{
      tg?.ready();
      tg?.expand();
    }catch(e){}

    /********************
     * Economy / Edge tuning (–ø–æ–¥–∫—Ä—É—Ç–∫–∞)
     ********************/
    // –ö–µ–π—Å—ã: –¥–µ–ª–∞–µ–º –¥–æ—Ä–æ–∂–µ/–¥–µ—à–µ–≤–ª–µ –≤—ã–ø–∞–¥–µ–Ω–∏–µ (—á–∞—â–µ –¥–µ—à—ë–≤–æ–µ)
    // 1.00 = —á–µ—Å—Ç–Ω–æ, 1.20 = —Å–∏–ª—å–Ω–µ–µ –ø–æ–¥–∫—Ä—É—Ç–∫–∞ –≤ –ø–æ–ª—å–∑—É –¥–µ—à—ë–≤—ã—Ö.
    const CASE_EDGE_LOW_BOOST = 1.22;

    // –ê–ø–≥—Ä–µ–π–¥: –±–∞–∑–æ–≤—ã–π —à–∞–Ω—Å * EDGE (–º–µ–Ω—å—à–µ 1 = —Ö—É–∂–µ –¥–ª—è —é–∑–µ—Ä–∞)
    const UPGRADE_EDGE = 0.88;

    // –ü—Ä–æ–¥–∞–∂–∞: —Å–∫–æ–ª—å–∫–æ % –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º (–¥–µ–º–æ)
    const SELL_PAYOUT = 0.80; // 80% –æ—Ç value –≤ –∑–≤—ë–∑–¥–∞—Ö

    /********************
     * Storage keys
     ********************/
    const STORAGE = {
      stars: "gb2_stars",
      inv: "gb2_inventory"
    };

    /********************
     * Assets (—Ç—ã –∑–∞–º–µ–Ω–∏—à—å –ø—É—Ç–∏)
     ********************/
    // –í—Å—Ç–∞–≤–ª—è–π —Å–≤–æ–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏:
    // gift.img: "img/gifts/xxx.png"
    // case.img: "img/cases/xxx.png"
    const GIFTS = [
      { id:"pin",   name:"Telegram Pin",               emoji:"üìé", value:3000, img:"img/gifts/pin.png" },
      { id:"lock",  name:"Heart Locket",              emoji:"üíô", value:1799, img:"img/gifts/lock.png" },
      { id:"watch", name:"Golden Watch",              emoji:"‚åö", value:980,  img:"img/gifts/watch.png" },
      { id:"cap",   name:"Durov‚Äôs Cap",               emoji:"üß¢", value:775,  img:"img/gifts/cap.png" },
      { id:"gem",   name:"Blue Gem",                  emoji:"üíé", value:462,  img:"img/gifts/gem.png" },
      { id:"peach", name:"Precious Peach",            emoji:"üçë", value:480,  img:"img/gifts/peach.png" },
      { id:"ring",  name:"Shiny Ring",                emoji:"üíç", value:260,  img:"img/gifts/ring.png" },
      { id:"jack",  name:"Jack-in-the-Box",           emoji:"üéÅ", value:231,  img:"img/gifts/jack.png" },
      { id:"candle",name:"B-Day Candle",              emoji:"üéÇ", value:149,  img:"img/gifts/candle.png" },
      { id:"muscle",name:"Power Arm",                 emoji:"üí™", value:120,  img:"img/gifts/muscle.png" },
      { id:"bear",  name:"Soft Toy",                  emoji:"üß∏", value:90,   img:"img/gifts/bear.png" },
      { id:"plane", name:"Paper Plane Charm",         emoji:"‚úàÔ∏è", value:85,   img:"img/gifts/plane.png" },
      { id:"duck",  name:"Little Duck",               emoji:"ü¶Ü", value:55,   img:"img/gifts/duck.png" },
      { id:"cookie",name:"Lucky Cookie",              emoji:"üç™", value:35,   img:"img/gifts/cookie.png" }
    ];

    // –ë–æ–ª—å—à–µ –∫–µ–π—Å–æ–≤ + –ø–æ—Ö–æ–∂–µ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ (2 –≤ —Ä—è–¥ + –æ–¥–∏–Ω —à–∏—Ä–æ–∫–∏–π)
    const CASES = [
      { id:"durov_mining", title:"Durov Mining", price:272, badge:"LIMITED", emoji:"‚õèÔ∏è", img:"img/cases/durov_mining.png",
        desc:"–õ–∏–º–∏—Ç–Ω—ã–π –∫–µ–π—Å. –î–µ—à—ë–≤—ã–µ —á–∞—â–µ, —Ä–µ–¥–∫–∏–µ —Ä–µ–∂–µ.",
        pool:[ {gift:"cookie",w:28},{gift:"duck",w:22},{gift:"plane",w:14},{gift:"bear",w:11},{gift:"muscle",w:9},{gift:"ring",w:6},{gift:"gem",w:4},{gift:"cap",w:3},{gift:"watch",w:2},{gift:"pin",w:1} ]
      },
      { id:"champion", title:"Champion", price:452, badge:"LIMITED", emoji:"ü•ä", img:"img/cases/champion.png",
        desc:"–°–µ—Ä–µ–¥–Ω—è–∫. –ï—Å—Ç—å —à–∞–Ω—Å –Ω–∞ —Ö–æ—Ä–æ—à–∏–µ –ø–æ–¥–∞—Ä–∫–∏.",
        pool:[ {gift:"cookie",w:18},{gift:"duck",w:18},{gift:"plane",w:12},{gift:"bear",w:10},{gift:"candle",w:10},{gift:"jack",w:9},{gift:"ring",w:7},{gift:"gem",w:6},{gift:"cap",w:4},{gift:"watch",w:3},{gift:"lock",w:2},{gift:"pin",w:1} ]
      },
      { id:"cemetery", title:"The Cemetery of Secrets", price:1104, badge:"LIMITED", emoji:"üïØÔ∏è", img:"img/cases/cemetery.png", big:true,
        desc:"–î–æ—Ä–æ–≥–æ–π –∫–µ–π—Å. –ù–æ –ø–æ–¥–∫—Ä—É—Ç–∫–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –µ—Å—Ç—å :)",
        pool:[ {gift:"duck",w:10},{gift:"candle",w:12},{gift:"jack",w:10},{gift:"ring",w:10},{gift:"gem",w:10},{gift:"cap",w:9},{gift:"watch",w:8},{gift:"lock",w:7},{gift:"pin",w:4} ]
      },

      // –µ—â—ë –∫–µ–π—Å—ã (—á—Ç–æ–±—ã –±—ã–ª–æ –º–Ω–æ–≥–æ –∫–∞–∫ –Ω–∞ —Ç–≤–æ–∏—Ö —Ñ–æ—Ç–æ)
      { id:"pepe_all_in", title:"PEPE ALL IN", price:55, badge:"HOT", emoji:"üê∏", img:"img/cases/pepe.png",
        desc:"–ë—ã—Å—Ç—Ä—ã–µ —Å–ø–∏–Ω—ã. –ß–∞—Å—Ç–æ –ø–∞–¥–∞–µ—Ç –¥–µ—à—ë–≤–æ–µ.",
        pool:[ {gift:"cookie",w:40},{gift:"duck",w:26},{gift:"plane",w:16},{gift:"bear",w:10},{gift:"muscle",w:6},{gift:"ring",w:2} ]
      },
      { id:"blue_drop", title:"Blue Drop", price:120, badge:"NEW", emoji:"üíß", img:"img/cases/blue_drop.png",
        desc:"–ù–µ–±–æ–ª—å—à–∞—è —Ü–µ–Ω–∞. –ù–µ–ø–ª–æ—Ö–æ–π —Ñ–∞—Ä–º.",
        pool:[ {gift:"cookie",w:34},{gift:"duck",w:24},{gift:"plane",w:16},{gift:"bear",w:12},{gift:"candle",w:8},{gift:"jack",w:4},{gift:"ring",w:2} ]
      },
      { id:"durov_classic", title:"Durov Classic", price:360, badge:"LIMITED", emoji:"üß¢", img:"img/cases/durov_classic.png",
        desc:"–ö–µ–π—Å –ø–æ–¥ —Å—Ç–∏–ª—å –∫–µ–ø–∫–∏.",
        pool:[ {gift:"duck",w:20},{gift:"bear",w:14},{gift:"candle",w:12},{gift:"jack",w:10},{gift:"ring",w:10},{gift:"gem",w:8},{gift:"cap",w:6},{gift:"watch",w:3},{gift:"lock",w:2},{gift:"pin",w:1} ]
      },
      { id:"gold_rush", title:"Gold Rush", price:680, badge:"HOT", emoji:"‚ú®", img:"img/cases/gold_rush.png",
        desc:"–°—Ç–∞–≤–∫–∞ –≤—ã—à–µ ‚Äî —Ä–∏—Å–∫–∏ –≤—ã—à–µ.",
        pool:[ {gift:"candle",w:16},{gift:"jack",w:14},{gift:"ring",w:12},{gift:"gem",w:12},{gift:"cap",w:10},{gift:"watch",w:8},{gift:"lock",w:6},{gift:"pin",w:3} ]
      },
      { id:"telegram_hearts", title:"Telegram Hearts", price:240, badge:"NEW", emoji:"üíô", img:"img/cases/hearts.png",
        desc:"–ö–µ–π—Å —Å —É–∫–ª–æ–Ω–æ–º –≤ locket.",
        pool:[ {gift:"cookie",w:20},{gift:"duck",w:20},{gift:"bear",w:14},{gift:"candle",w:12},{gift:"ring",w:10},{gift:"gem",w:8},{gift:"lock",w:6},{gift:"watch",w:3},{gift:"pin",w:1} ]
      },
      { id:"skyline", title:"Skyline", price:190, badge:"NEW", emoji:"üåå", img:"img/cases/skyline.png",
        desc:"–õ—ë–≥–∫–∏–π –∫–µ–π—Å. –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
        pool:[ {gift:"cookie",w:30},{gift:"duck",w:22},{gift:"plane",w:18},{gift:"bear",w:12},{gift:"muscle",w:10},{gift:"candle",w:6},{gift:"ring",w:2} ]
      }
    ];

    /********************
     * State
     ********************/
    let stars = loadNumber(STORAGE.stars, 45.4);
    let inventory = loadJSON(STORAGE.inv, {}); // {giftId: qty}

    let currentCase = CASES[3];
    let openCount = 1;

    let upgradeFrom = null;
    let upgradeTo = null;
    let dialAngle = 0;

    /********************
     * DOM
     ********************/
    const starsValue = document.getElementById("starsValue");
    const casesGrid  = document.getElementById("casesGrid");
    const invGrid = document.getElementById("invGrid");

    const pages = {
      home: document.getElementById("pageHome"),
      upgrade: document.getElementById("pageUpgrade"),
      inv: document.getElementById("pageInv")
    };

    // nav pill
    const navPill = document.getElementById("navPill");

    // modal
    const caseModal = document.getElementById("caseModal");
    const closeModal = document.getElementById("closeModal");
    const modalHeader = document.getElementById("modalHeader");
    const modalBigImg = document.getElementById("modalBigImg");
    const modalName = document.getElementById("modalName");
    const modalDesc = document.getElementById("modalDesc");
    const modalPrice = document.getElementById("modalPrice");
    const btnCost = document.getElementById("btnCost");
    const btnOpenCase = document.getElementById("btnOpenCase");
    const btnShowContents = document.getElementById("btnShowContents");
    const countPills = document.getElementById("countPills");
    const reel = document.getElementById("reel");
    const rouletteHint = document.getElementById("rouletteHint");
    const resultToast = document.getElementById("resultToast");
    const resImg = document.getElementById("resImg");
    const resName = document.getElementById("resName");
    const resValue = document.getElementById("resValue");
    const resTag = document.getElementById("resTag");

    // upgrade
    const pickFromBtn = document.getElementById("pickFromBtn");
    const pickToBtn = document.getElementById("pickToBtn");
    const fromPick = document.getElementById("fromPick");
    const toPick = document.getElementById("toPick");
    const btnUpgrade = document.getElementById("btnUpgrade");
    const btnResetUpgrade = document.getElementById("btnResetUpgrade");
    const upgradeHint = document.getElementById("upgradeHint");
    const upgradeResultNote = document.getElementById("upgradeResultNote");
    const dialArc = document.getElementById("dialArc");
    const dialArrow = document.getElementById("dialArrow");
    const chanceText = document.getElementById("chanceText");

    // picker
    const pickerOverlay = document.getElementById("pickerOverlay");
    const pickerTitle = document.getElementById("pickerTitle");
    const pickerBody = document.getElementById("pickerBody");
    const pickerClose = document.getElementById("pickerClose");
    let pickerMode = "from"; // from|to

    // toast
    const toast = document.getElementById("toast");

    /********************
     * Init
     ********************/
    renderStars();
    renderCases();
    renderInventory();
    renderUpgrade();
    buildReel(currentCase);

    // entrance
    gsap.fromTo(".topbar", {y:-10, opacity:0}, {y:0, opacity:1, duration:.45, ease:"power2.out"});
    gsap.fromTo(".navBar", {y:12, opacity:0}, {y:0, opacity:1, duration:.5, ease:"power2.out", delay:.05});
    updateNavPill(0, false);

    /********************
     * Top actions
     ********************/
    document.getElementById("btnBack").addEventListener("click", ()=>{
      if(tg?.BackButton){
        tg.close();
      }else{
        showToast("–î–µ–º–æ. –í Mini App —ç—Ç–∞ –∫–Ω–æ–ø–∫–∞ –æ–±—ã—á–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
      }
    });

    document.getElementById("btnAddStars").addEventListener("click", ()=>{
      stars = round1(stars + 20);
      saveNumber(STORAGE.stars, stars);
      renderStars();
      pulse(".wallet");
      showToast("–î–µ–º–æ: +20‚òÖ");
    });

    document.getElementById("btnDemoFill").addEventListener("click", ()=>{
      addToInv("duck", 4);
      addToInv("cookie", 6);
      addToInv("candle", 2);
      addToInv("jack", 1);
      addToInv("cap", 1);
      addToInv("gem", 1);
      renderInventory();
      showToast("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∑–∞–ø–æ–ª–Ω–µ–Ω (–¥–µ–º–æ)");
    });

    /********************
     * Tabs + pill slide
     ********************/
    document.querySelectorAll(".tabBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tab = btn.dataset.tab;
        const idx = Number(btn.dataset.index || "0");
        setTab(tab, idx);
      });
    });

    function setTab(tab, idx){
      document.querySelectorAll(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      Object.values(pages).forEach(p=>p.classList.remove("active"));

      const pageEl = tab==="home"?pages.home:tab==="upgrade"?pages.upgrade:pages.inv;
      pageEl.classList.add("active");

      updateNavPill(idx, true);

      gsap.fromTo(pageEl, {opacity:0, y:10}, {opacity:1, y:0, duration:.28, ease:"power2.out"});
      document.getElementById("scrollArea").scrollTop = 0;

      renderInventory();
      renderUpgrade();
    }

    function updateNavPill(index, animate=true){
      const bar = document.getElementById("navBar");
      const w = bar.clientWidth;
      const pillW = (w - 16) / 3; // (100% - 16px)/3
      const x = 8 + index * pillW;
      if(!animate){
        gsap.set(navPill, {x: x - 8}); // navPill already has left:8px; easier to move by translateX
        return;
      }
      gsap.to(navPill, {x: x - 8, duration:.28, ease:"power2.out"});
    }

    window.addEventListener("resize", ()=>{
      const active = document.querySelector(".tabBtn.active");
      const idx = Number(active?.dataset.index || "0");
      updateNavPill(idx, false);
    });

    /********************
     * Cases grid
     ********************/
    function renderCases(){
      casesGrid.innerHTML = "";
      // –°–¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—ã–µ 2, –ø–æ—Ç–æ–º BIG, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ (–∫–∞–∫ ‚Äú–ø–æ—Ö–æ–∂–µ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Äù)
      const ordered = [];
      const big = CASES.find(c=>c.big);
      const notBig = CASES.filter(c=>!c.big);

      // 2 —Å–≤–µ—Ä—Ö—É
      ordered.push(notBig[0], notBig[1]);
      // –ø–æ—Ç–æ–º —à–∏—Ä–æ–∫–∏–π
      if(big) ordered.push(big);
      // –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
      notBig.slice(2).forEach(c=>ordered.push(c));

      ordered.forEach(c=>{
        const el = document.createElement("div");
        el.className = "caseCard" + (c.big ? " big" : "");
        el.innerHTML = `
          <div class="badge"><span class="dot"></span>${escapeHtml(c.badge)}</div>
          <div class="caseHero">
            <div class="caseAvatar">
              ${c.img ? `<img src="${escapeAttr(c.img)}" alt="">` : `<div class="fallback">${escapeHtml(c.emoji || "üéÅ")}</div>`}
            </div>
          </div>
          <div class="caseMeta">
            <div class="caseName">${escapeHtml(c.title)}</div>
            <div class="priceRow">
              <div class="left"><span class="star"></span><span>${formatStars(c.price)}</span></div>
              <div class="miniTag">Open</div>
            </div>
          </div>
        `;
        el.addEventListener("click", ()=> openCaseModal(c));
        casesGrid.appendChild(el);

        el.addEventListener("pointerdown", ()=> gsap.to(el, {scale:0.985, duration:.12, ease:"power2.out"}));
        el.addEventListener("pointerup", ()=> gsap.to(el, {scale:1, duration:.18, ease:"power2.out"}));
        el.addEventListener("pointerleave", ()=> gsap.to(el, {scale:1, duration:.18, ease:"power2.out"}));
      });
    }

    /********************
     * Modal + roulette
     ********************/
    closeModal.addEventListener("click", hideModal);
    caseModal.addEventListener("click", (e)=>{
      if(e.target === caseModal) hideModal();
    });

    countPills.addEventListener("click", (e)=>{
      const pill = e.target.closest(".pill");
      if(!pill) return;
      openCount = Number(pill.dataset.n || "1");
      [...countPills.querySelectorAll(".pill")].forEach(p=>p.classList.toggle("active", p===pill));
      updateModalPrice();
      pulse("#countPills");
    });

    btnShowContents.addEventListener("click", ()=>{
      const content = currentCase.pool
        .map(p=>{
          const g = getGift(p.gift);
          return `${g.emoji} ${g.name} (${g.value}‚òÖ)`;
        })
        .join("\n");
      alert("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞ (–¥–µ–º–æ):\n\n" + content);
    });

    btnOpenCase.addEventListener("click", async ()=>{
      const totalCost = currentCase.price * openCount;
      if(stars + 1e-9 < totalCost){
        showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚òÖ. –ù–∞–∂–º–∏ + —á—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω–∏—Ç—å (–¥–µ–º–æ).");
        wiggle(".wallet");
        return;
      }

      stars = round1(stars - totalCost);
      saveNumber(STORAGE.stars, stars);
      renderStars();

      btnOpenCase.disabled = true;
      rouletteHint.textContent = "–ö—Ä—É—Ç–∏–º‚Ä¶";
      resultToast.classList.remove("show");

      for(let i=0;i<openCount;i++){
        const wonGiftId = weightedPickWithEdge(currentCase.pool);
        const won = getGift(wonGiftId);

        await spinTo(wonGiftId, currentCase);

        addToInv(wonGiftId, 1);
        renderInventory();

        // result
        resImg.innerHTML = giftThumbHTML(won, 44);
        resName.textContent = won.name;
        resValue.textContent = formatStars(won.value);
        resTag.className = "tagWin good";
        resTag.innerHTML = `<span>‚úî</span><span>WIN</span>`;
        resultToast.classList.add("show");
        gsap.fromTo(resultToast, {y:10, opacity:0}, {y:0, opacity:1, duration:.22, ease:"power2.out"});

        if(i < openCount-1){
          await sleep(450);
          resultToast.classList.remove("show");
          rouletteHint.textContent = `–ï—â—ë ${openCount-1-i}‚Ä¶`;
          await sleep(220);
        }
      }

      rouletteHint.textContent = "–ì–æ—Ç–æ–≤–æ ‚úÖ";
      btnOpenCase.disabled = false;
      pulse(".resultToast");
    });

    function openCaseModal(c){
      currentCase = c;
      openCount = 1;
      [...countPills.querySelectorAll(".pill")].forEach((p,idx)=>p.classList.toggle("active", idx===0));

      modalHeader.textContent = c.title.toUpperCase();
      modalName.textContent = c.title;
      modalDesc.textContent = c.desc;

      modalBigImg.innerHTML = c.img
        ? `<img src="${escapeAttr(c.img)}" alt="">`
        : `<div class="fallback">${escapeHtml(c.emoji || "üéÅ")}</div>`;

      buildReel(c);
      updateModalPrice();
      rouletteHint.textContent = "–ù–∞–∂–º–∏ ‚ÄúOpen case‚Äù";
      resultToast.classList.remove("show");

      caseModal.classList.add("show");
      gsap.fromTo(".modal", {y:20, opacity:0}, {y:0, opacity:1, duration:.26, ease:"power2.out"});
      pulse(".modal");
    }

    function hideModal(){
      gsap.to(".modal", {y:20, opacity:0, duration:.16, ease:"power2.in", onComplete:()=>{
        caseModal.classList.remove("show");
        gsap.set(".modal", {clearProps:"all"});
      }});
    }

    function updateModalPrice(){
      const total = currentCase.price * openCount;
      modalPrice.textContent = formatStars(total);
      btnCost.textContent = formatStars(total);
    }

    function buildReel(caseObj){
      reel.innerHTML = "";
      const base = [];
      caseObj.pool.forEach(p=>{
        const g = getGift(p.gift);
        for(let k=0;k<Math.max(1, Math.round(p.w/8));k++) base.push(g);
      });

      const strip = [];
      for(let i=0;i<64;i++){
        strip.push(base[randInt(0, base.length-1)]);
      }

      strip.forEach(g=>{
        const chip = document.createElement("div");
        chip.className = "itemChip";
        chip.dataset.gift = g.id;
        chip.innerHTML = `
          <div class="chipImg">${giftThumbHTML(g, 42)}</div>
          <div class="n">${escapeHtml(g.name)}</div>
        `;
        reel.appendChild(chip);
      });

      gsap.set(reel, {x:0});
    }

    async function spinTo(giftId, caseObj){
      buildReel(caseObj);

      const chips = [...reel.querySelectorAll(".itemChip")];
      const targetIndex = randInt(40, 56);

      // –∑–∞–º–µ–Ω–∏—Ç—å —Ü–µ–ª–µ–≤–æ–π –Ω–∞ –≤—ã–∏–≥—Ä—ã—à
      const g = getGift(giftId);
      chips[targetIndex].dataset.gift = giftId;
      chips[targetIndex].innerHTML = `
        <div class="chipImg">${giftThumbHTML(g, 42)}</div>
        <div class="n">${escapeHtml(g.name)}</div>
      `;

      const chipW = 114; // —à–∏—Ä–∏–Ω–∞ + gap
      const containerW = document.querySelector(".track").clientWidth;
      const centerX = containerW / 2;
      const leftPadding = 14;
      const targetX = leftPadding + targetIndex * chipW + 52; // ~half chip
      const finalX = centerX - targetX;

      const dur = 2.0 + Math.random()*0.6;
      const overshoot = finalX - (45 + Math.random()*45);

      gsap.set(reel, {x: 20});
      await sleep(50);

      await gsapToPromise(reel, { x: overshoot, duration: dur, ease: "power3.out" });
      await gsapToPromise(reel, { x: finalX, duration: 0.5, ease: "elastic.out(1, 0.35)" });

      const winChip = chips[targetIndex];
      gsap.fromTo(winChip, {scale:1}, {scale:1.07, duration:.16, yoyo:true, repeat:1, ease:"power2.out"});
      pulse(".centerLine");
    }

    /********************
     * Inventory (2 –≤ —Ä—è–¥ + –∫–Ω–æ–ø–∫–∏)
     ********************/
    function renderInventory(){
      saveJSON(STORAGE.inv, inventory);

      const entries = Object.entries(inventory)
        .filter(([_,qty])=>qty>0)
        .map(([id,qty])=>{
          const g = getGift(id);
          return { ...g, qty };
        })
        .sort((a,b)=> b.value - a.value);

      if(entries.length===0){
        invGrid.innerHTML = `<div class="note" style="grid-column: span 2;">–ü—É—Å—Ç–æ. –û—Ç–∫—Ä–æ–π –∫–µ–π—Å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ‚Äú–î–æ–º‚Äù.</div>`;
      } else {
        invGrid.innerHTML = "";
        entries.forEach(it=>{
          const el = document.createElement("div");
          el.className = "giftCard";
          el.innerHTML = `
            <div class="giftTop">
              <div class="giftQty">x${it.qty}</div>
              <div class="giftPrice"><span class="star"></span>${formatStars(it.value)}</div>
            </div>

            <div class="giftImg">
              ${it.img ? `<img src="${escapeAttr(it.img)}" alt="">` : `<div class="fallback">${escapeHtml(it.emoji || "üéÅ")}</div>`}
            </div>

            <div class="giftMeta">
              <div class="giftName">${escapeHtml(it.name)}</div>
              <div class="giftPrice" style="opacity:.85">id: <span style="opacity:.85">${escapeHtml(it.id)}</span></div>
            </div>

            <div class="giftActions">
              <button class="btnSmall" data-act="sell" data-id="${escapeAttr(it.id)}">–ü—Ä–æ–¥–∞—Ç—å</button>
              <button class="btnSmall primary" data-act="withdraw" data-id="${escapeAttr(it.id)}">–í—ã–≤–µ—Å—Ç–∏</button>
            </div>
          `;
          invGrid.appendChild(el);
        });
      }

      // attach actions
      invGrid.querySelectorAll("button.btnSmall").forEach(b=>{
        b.addEventListener("click", ()=>{
          const act = b.dataset.act;
          const id = b.dataset.id;
          if(!id) return;

          if(act === "sell"){
            sellGift(id);
          }else if(act === "withdraw"){
            withdrawGift(id);
          }
        });
      });
    }

    function sellGift(giftId){
      const qty = inventory[giftId] || 0;
      if(qty <= 0) return;

      const g = getGift(giftId);
      // –¥–µ–º–æ: –ø—Ä–æ–¥–∞—ë–º 1 —à—Ç—É–∫—É
      removeFromInv(giftId, 1);

      const payout = round1((g.value * SELL_PAYOUT));
      stars = round1(stars + payout);

      saveNumber(STORAGE.stars, stars);
      renderStars();
      renderInventory();
      renderUpgrade();

      showToast(`–ü—Ä–æ–¥–∞–Ω–æ: +${formatStars(payout)}‚òÖ (–¥–µ–º–æ)`);
      pulse(".wallet");
    }

    function withdrawGift(giftId){
      const qty = inventory[giftId] || 0;
      if(qty <= 0) return;

      const g = getGift(giftId);
      // –¥–µ–º–æ: –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
      showToast(`–í—ã–≤–æ–¥: ${g.name} (–¥–µ–º–æ). –¢—É—Ç –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –±–æ—Ç–∞/—Å–µ—Ä–≤–µ—Ä.`);
      pulse(".giftCard");
    }

    document.getElementById("btnClearInv").addEventListener("click", ()=>{
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å?")) return;
      inventory = {};
      saveJSON(STORAGE.inv, inventory);
      upgradeFrom = null;
      upgradeTo = null;
      renderInventory();
      renderUpgrade();
      showToast("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –æ—á–∏—â–µ–Ω");
    });

    function addToInv(giftId, qty){
      inventory[giftId] = (inventory[giftId]||0) + qty;
      saveJSON(STORAGE.inv, inventory);
    }
    function removeFromInv(giftId, qty){
      const cur = inventory[giftId] || 0;
      const next = Math.max(0, cur - qty);
      inventory[giftId] = next;
      saveJSON(STORAGE.inv, inventory);
    }

    /********************
     * Upgrade (—Å—Ç—Ä–µ–ª–∫–∞ –∫—Ä—É—Ç–∏—Ç—Å—è + –ø–æ–ø–∞–¥–∞–Ω–∏–µ/–Ω–µ—Ç)
     ********************/
    pickFromBtn.addEventListener("click", ()=>{
      pickerMode = "from";
      openPickerFromInventory();
    });
    pickToBtn.addEventListener("click", ()=>{
      pickerMode = "to";
      openPickerFromCatalog();
    });

    btnResetUpgrade.addEventListener("click", ()=>{
      upgradeFrom = null;
      upgradeTo = null;
      upgradeResultNote.style.display = "none";
      renderUpgrade();
      showToast("–°–±—Ä–æ—à–µ–Ω–æ");
    });

    btnUpgrade.addEventListener("click", async ()=>{
      const chance = calcChance();
      if(!upgradeFrom || !upgradeTo || chance<=0){
        wiggle("#upgradeHint");
        showToast("–í—ã–±–µ—Ä–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∏ —Ü–µ–ª—å");
        return;
      }
      if((inventory[upgradeFrom]||0) <= 0){
        showToast("–ù–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ");
        renderUpgrade();
        return;
      }

      btnUpgrade.disabled = true;
      upgradeResultNote.style.display = "none";

      // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å–ø–µ—Ö –∑–∞—Ä–∞–Ω–µ–µ
      const roll = Math.random()*100;
      const success = roll < chance;

      // –∫—Ä—É—Ç–∏–º —Å—Ç—Ä–µ–ª–∫—É: —á–µ–º –º–µ–Ω—å—à–µ —à–∞–Ω—Å, —Ç–µ–º –º–µ–Ω—å—à–µ —Å–µ–∫—Ç–æ—Ä WIN
      // —Ä–µ–∞–ª–∏–∑—É–µ–º: –µ—Å–ª–∏ success -> —É–≥–æ–ª –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å–µ–∫—Ç–æ—Ä WIN, –∏–Ω–∞—á–µ -> –≤ —Å–µ–∫—Ç–æ—Ä LOSE
      const winSector = chance; // % –∫—Ä—É–≥–∞
      const targetAngle = pickAngleByResult(success, winSector);

      // spin animation (–Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä–æ—Ç–æ–≤ + –ø–æ–ø–∞–¥–∞–Ω–∏–µ)
      const spins = 4 + randInt(0,2);
      const final = (dialAngle % 360) + spins*360 + targetAngle;
      dialAngle = final;

      await gsapToPromise(dialArrow, { rotation: final, duration: 1.35, ease:"power3.out" });

      // —Ä–∞—Å—Ö–æ–¥: 1 –∏—Å—Ö–æ–¥–Ω—ã–π –≤—Å–µ–≥–¥–∞
      removeFromInv(upgradeFrom, 1);

      if(success){
        addToInv(upgradeTo, 1);
        upgradeResultNote.style.display = "block";
        upgradeResultNote.innerHTML = `‚úÖ –£—Å–ø–µ—Ö! <b>${escapeHtml(getGift(upgradeTo).name)}</b> –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.`;
        pulse("#slotTo");
        showToast("–ê–ø–≥—Ä–µ–π–¥: WIN");
      }else{
        upgradeResultNote.style.display = "block";
        upgradeResultNote.innerHTML = `‚ùå –ù–µ—É–¥–∞—á–∞. –ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ —Å–≥–æ—Ä–µ–ª.`;
        wiggle("#slotFrom");
        showToast("–ê–ø–≥—Ä–µ–π–¥: LOSE");
      }

      renderInventory();

      // –µ—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî —Å–±—Ä–æ—Å
      if(upgradeFrom && (inventory[upgradeFrom]||0) <= 0) upgradeFrom = null;

      btnUpgrade.disabled = false;
      renderUpgrade();
    });

    function renderUpgrade(){
      // from slot
      if(upgradeFrom){
        const g = getGift(upgradeFrom);
        const qty = inventory[upgradeFrom] || 0;
        fromPick.innerHTML = `
          <div class="pImg">${giftThumbHTML(g, 44)}</div>
          <div class="info">
            <b>${escapeHtml(g.name)}</b>
            <span><span class="star"></span>${formatStars(g.value)} ‚Ä¢ <span style="opacity:.75">x${qty}</span></span>
          </div>
        `;
      }else{
        fromPick.innerHTML = `
          <div class="pImg"><div class="fallback">‚ùî</div></div>
          <div class="info">
            <b>–ù–µ –≤—ã–±—Ä–∞–Ω</b>
            <span style="opacity:.75">–í—ã–±–µ—Ä–∏ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</span>
          </div>
        `;
      }

      // to slot
      if(upgradeTo){
        const g = getGift(upgradeTo);
        toPick.innerHTML = `
          <div class="pImg">${giftThumbHTML(g, 44)}</div>
          <div class="info">
            <b>${escapeHtml(g.name)}</b>
            <span><span class="star"></span>${formatStars(g.value)} ‚Ä¢ <span style="opacity:.75">—Ü–µ–ª—å</span></span>
          </div>
        `;
      }else{
        toPick.innerHTML = `
          <div class="pImg"><div class="fallback">üéØ</div></div>
          <div class="info">
            <b>–ù–µ –≤—ã–±—Ä–∞–Ω</b>
            <span style="opacity:.75">–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å</span>
          </div>
        `;
      }

      const chance = calcChance();
      setDialChance(chance);

      if(upgradeFrom && upgradeTo){
        upgradeHint.innerHTML = `–®–∞–Ω—Å: <b>${chance.toFixed(2)}%</b>. –ù–∞–∂–∏–º–∞–π ‚Äú–ê–ø–≥—Ä–µ–π–¥‚Äù.`;
        btnUpgrade.disabled = false;
      }else{
        upgradeHint.innerHTML = `–í—ã–±–µ—Ä–∏ <b>–∏—Å—Ö–æ–¥–Ω—ã–π</b> –ø–æ–¥–∞—Ä–æ–∫ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏ <b>—Ü–µ–ª—å</b> ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —à–∞–Ω—Å –∏ –∫–Ω–æ–ø–∫–∞.`;
        btnUpgrade.disabled = true;
      }
    }

    function calcChance(){
      if(!upgradeFrom || !upgradeTo) return 0;
      const a = getGift(upgradeFrom).value;
      const b = getGift(upgradeTo).value;
      if(b <= 0) return 0;

      // –±–∞–∑–æ–≤—ã–π —à–∞–Ω—Å
      let raw = (a / b) * 100;

      // house edge
      raw *= UPGRADE_EDGE;

      // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
      raw = clamp(raw, 1.2, 95);

      // –µ—Å–ª–∏ –∞–ø–≥—Ä–µ–π–¥ –≤–Ω–∏–∑ ‚Äî –ø–æ—á—Ç–∏ –≥–∞—Ä–∞–Ω—Ç (–Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ 100)
      if(a >= b){
        raw = clamp(88 + (a-b)/b*8, 88, 97);
      }
      return raw;
    }

    function setDialChance(percent){
      chanceText.textContent = `${percent.toFixed(2)}%`;

      // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å–µ–∫—Ç–æ—Ä WIN: clip-path –¥–µ–ª–∞–µ–º ‚Äú–±–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ‚Äù
      // –ú—ã –∏–º–∏—Ç–∏—Ä—É–µ–º —Å–µ–∫—Ç–æ—Ä: –º–µ–Ω—è–µ–º opacity –∏ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–≤–æ—Ä–æ—Ç + –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å.
      // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: —á–µ–º –±–æ–ª—å—à–µ —à–∞–Ω—Å, —Ç–µ–º —è—Ä—á–µ –∞—Ä–∫–∞.
      const o = clamp(0.25 + percent/100 * 0.55, 0.25, 0.85);
      dialArc.style.opacity = o;

      if(percent >= 60){
        dialArc.style.borderColor = "rgba(37,227,154,.30)";
      }else if(percent >= 25){
        dialArc.style.borderColor = "rgba(74,163,255,.26)";
      }else{
        dialArc.style.borderColor = "rgba(255,74,106,.26)";
      }
    }

    function pickAngleByResult(success, winPercent){
      // –∑–æ–Ω–∞ WIN ‚Äî 0..winPercent*3.6 –≥—Ä–∞–¥—É—Å–æ–≤
      const winDeg = clamp(winPercent, 1.2, 95) * 3.6;

      // —Å—Ç—Ä–µ–ª–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ ‚Äú–ø–æ–ø–∞–¥–∞–µ—Ç‚Äù: —É—Å–ø–µ—Ö -> –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö winDeg, –∏–Ω–∞—á–µ -> –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏
      if(success){
        return randFloat(8, Math.max(10, winDeg - 8));
      }else{
        // —É–≥–æ–ª –≤ –∑–æ–Ω–µ LOSE: winDeg..360
        return randFloat(Math.min(360 - 8, winDeg + 8), 360 - 8);
      }
    }

    /********************
     * Picker
     ********************/
    function openPickerFromInventory(){
      const list = Object.entries(inventory).filter(([id,qty])=>qty>0);
      if(list.length===0){
        showToast("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç");
        setTab("home", 0);
        return;
      }

      pickerTitle.textContent = "–í—ã–±–µ—Ä–∏ –∏—Å—Ö–æ–¥–Ω—ã–π";
      pickerBody.innerHTML = "";
      list
        .map(([id,qty])=>{
          const g = getGift(id);
          return {...g, qty};
        })
        .sort((a,b)=>b.value-a.value)
        .forEach(g=>{
          const el = document.createElement("div");
          el.className = "pickCard";
          el.innerHTML = `
            <div class="row">
              <div class="pImg">${giftThumbHTML(g, 40)}</div>
              <div class="pr">x${g.qty}</div>
            </div>
            <div class="nm">${escapeHtml(g.name)}</div>
            <div class="sub"><span class="star"></span>${formatStars(g.value)}</div>
          `;
          el.addEventListener("click", ()=>{
            upgradeFrom = g.id;
            closePicker();
            renderUpgrade();
            pulse("#slotFrom");
          });
          pickerBody.appendChild(el);
        });

      openPicker();
    }

    function openPickerFromCatalog(){
      pickerTitle.textContent = "–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å";
      pickerBody.innerHTML = "";
      GIFTS
        .slice()
        .sort((a,b)=>b.value-a.value)
        .forEach(g=>{
          const el = document.createElement("div");
          el.className = "pickCard";
          el.innerHTML = `
            <div class="row">
              <div class="pImg">${giftThumbHTML(g, 40)}</div>
              <div class="pr"><span class="star"></span>${formatStars(g.value)}</div>
            </div>
            <div class="nm">${escapeHtml(g.name)}</div>
            <div class="sub">id: ${escapeHtml(g.id)}</div>
          `;
          el.addEventListener("click", ()=>{
            upgradeTo = g.id;
            closePicker();
            renderUpgrade();
            pulse("#slotTo");
          });
          pickerBody.appendChild(el);
        });

      openPicker();
    }

    function openPicker(){
      pickerOverlay.classList.add("show");
      gsap.fromTo(".sheet", {y:20, opacity:0}, {y:0, opacity:1, duration:.24, ease:"power2.out"});
    }
    function closePicker(){
      gsap.to(".sheet", {y:20, opacity:0, duration:.14, ease:"power2.in", onComplete:()=>{
        pickerOverlay.classList.remove("show");
        gsap.set(".sheet", {clearProps:"all"});
      }});
    }
    pickerClose.addEventListener("click", closePicker);
    pickerOverlay.addEventListener("click", (e)=>{
      if(e.target === pickerOverlay) closePicker();
    });

    /********************
     * Helpers
     ********************/
    function getGift(id){
      return GIFTS.find(g=>g.id===id) || {id, name:"Unknown", emoji:"‚ùì", value:0, img:""};
    }

    // –ü–æ–¥–∫—Ä—É—Ç–∫–∞ –∫–µ–π—Å–æ–≤: –¥–µ–ª–∞–µ–º –¥–µ—à—ë–≤—ã–µ —á–∞—â–µ, –¥–æ—Ä–æ–≥–∏–µ —Ä–µ–∂–µ (–Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –∏–∑ pool).
    function weightedPickWithEdge(pool){
      // –Ω–∞—Ö–æ–¥–∏–º min/max value –≤ pool
      const gifts = pool.map(p=>getGift(p.gift));
      const minV = Math.min(...gifts.map(g=>g.value));
      const maxV = Math.max(...gifts.map(g=>g.value));

      const adjusted = pool.map(p=>{
        const g = getGift(p.gift);
        const t = (g.value - minV) / Math.max(1, (maxV - minV)); // 0..1 (0 = –¥–µ—à—ë–≤—ã–π)
        // –¥–µ—à—ë–≤—ã–µ –±—É—Å—Ç–∏–º, –¥–æ—Ä–æ–≥–∏–µ —Ä–µ–∂–µ–º
        const mult = lerp(CASE_EDGE_LOW_BOOST, 1/CASE_EDGE_LOW_BOOST, t);
        return { gift:p.gift, w: p.w * mult };
      });

      const sum = adjusted.reduce((s,p)=>s+p.w,0);
      let r = Math.random()*sum;
      for(const p of adjusted){
        r -= p.w;
        if(r <= 0) return p.gift;
      }
      return adjusted[adjusted.length-1].gift;
    }

    function renderStars(){
      starsValue.textContent = formatStars(stars);
    }

    function formatStars(n){
      const x = Number(n);
      if(Number.isNaN(x)) return String(n);
      if(Math.abs(x - Math.round(x)) < 1e-9) return String(Math.round(x));
      return x.toFixed(1);
    }

    function round1(x){ return Math.round(x*10)/10; }

    function loadNumber(key, fallback){
      const v = localStorage.getItem(key);
      if(v===null || v===undefined) return fallback;
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function saveNumber(key, val){
      localStorage.setItem(key, String(val));
    }
    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if(!v) return fallback;
        return JSON.parse(v);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, obj){
      localStorage.setItem(key, JSON.stringify(obj));
    }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function randFloat(a,b){ return a + Math.random()*(b-a); }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function gsapToPromise(target, vars){
      return new Promise(res=> gsap.to(target, {...vars, onComplete: res}) );
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(s).replaceAll("`","&#096;");
    }

    function pulse(sel){
      const el = document.querySelector(sel);
      if(!el) return;
      gsap.fromTo(el, {scale:1}, {scale:1.015, duration:.14, yoyo:true, repeat:1, ease:"power2.out"});
    }
    function wiggle(sel){
      const el = document.querySelector(sel);
      if(!el) return;
      gsap.fromTo(el, {x:0}, {x:7, duration:.06, yoyo:true, repeat:5, ease:"power1.inOut"});
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      gsap.fromTo(toast, {y:10, opacity:0}, {y:0, opacity:1, duration:.18, ease:"power2.out"});
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{
        gsap.to(toast, {y:10, opacity:0, duration:.16, ease:"power2.in", onComplete:()=>toast.classList.remove("show")});
      }, 1800);
    }

    function giftThumbHTML(gift, size=42){
      const g = gift || {};
      if(g.img){
        return `<img src="${escapeAttr(g.img)}" alt="" style="width:${size}px;height:${size}px;object-fit:cover;display:block;">`;
      }
      return `<div class="fallback">${escapeHtml(g.emoji || "üéÅ")}</div>`;
    }

    /********************
     * small: keep upgrade valid
     ********************/
    window.addEventListener("storage", ()=>{
      inventory = loadJSON(STORAGE.inv, {});
      if(upgradeFrom && (inventory[upgradeFrom]||0) <= 0) upgradeFrom = null;
      renderInventory();
      renderUpgrade();
    });
  </script>
</body>
</html>
