<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Gifts Battle — Cases / Upgrade / Inventory</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <style>
    :root{
      --bg0:#07090e;
      --bg1:#0a0f1b;
      --card:#141a28;
      --card2:#101626;
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(110,170,255,.22);
      --text:#eaf2ff;
      --muted:#9fb3d6;
      --blue:#4aa3ff;
      --blue2:#2b7bff;
      --good:#25e39a;
      --bad:#ff4a6a;
      --gold:#ffd56a;
      --shadow: 0 16px 50px rgba(0,0,0,.55);
      --r: 20px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 50% -10%, rgba(74,163,255,.12), transparent 58%),
        radial-gradient(900px 600px at 10% 0%, rgba(74,163,255,.08), transparent 62%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    /* App layout */
    .app{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      padding-top: var(--safeTop);
    }

    .topbar{
      padding: 14px 16px 10px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
    }
    .titleWrap{flex:1; min-width:0}
    .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1.1;
      margin:0;
    }
    .subtitle{
      margin:2px 0 0;
      font-size:12px;
      color:rgba(255,255,255,.55);
    }

    .wallet{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 8px 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .plus{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(43,123,255,.95));
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.22);
      cursor:pointer;
    }
    .balance{
      font-weight:800; font-size:14px;
      display:flex; align-items:center; gap:6px;
      min-width:72px; justify-content:flex-end;
    }
    .star{
      display:inline-grid; place-items:center;
      width:18px;height:18px;
      color:var(--gold);
      filter: drop-shadow(0 6px 16px rgba(255,213,106,.18));
    }
    .star::before{content:"★"; font-size:16px}

    .content{
      flex:1;
      overflow:auto;
      padding: 6px 14px 102px;
      -webkit-overflow-scrolling: touch;
    }

    .sectionTitle{
      margin: 12px 4px 10px;
      text-transform:uppercase;
      letter-spacing:1.6px;
      font-weight:900;
      color: rgba(255,255,255,.72);
      font-size: 13px;
      text-align:center;
    }

    /* Cases grid (похоже на 1 фото) */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .caseCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      cursor:pointer;
      position:relative;
      min-height: 232px;
      transform: translateZ(0);
    }

    /* УБРАЛИ волны/спец-эффекты на карточках: без ::after и "shine" */

    .badge{
      position:absolute;
      top:10px; left:10px;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.12);
      padding: 6px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight:900;
      letter-spacing:.6px;
      z-index:3;
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:7px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(74,163,255,.95);
      box-shadow: 0 0 0 4px rgba(74,163,255,.10);
    }

    .caseHero{
      height: 146px;
      display:grid; place-items:center;
      padding: 14px 14px 0;
    }

    /* Вместо эмодзи — место под аватар/картинку кейса */
    .caseImg{
      width: 100%;
      height: 120px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }
    .caseImg img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
    }
    .caseImg .ph{
      position:absolute; inset:0;
      display:grid; place-items:center;
      color: rgba(255,255,255,.55);
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size:12px;
    }

    .caseMeta{
      padding: 10px 14px 14px;
    }
    .caseName{
      font-weight:900;
      font-size: 14px;
      margin: 0 0 8px;
      color: rgba(255,255,255,.92);
      min-height: 36px;
      line-height:1.15;
    }
    .priceRow{
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      color: rgba(255,255,255,.92);
    }

    .bigCard{
      grid-column: span 2;
      min-height: 220px;
    }
    .bigCard .caseHero{height: 156px;}
    .bigCard .caseImg{height: 132px;}

    /* Bottom nav + Telegram-like sliding indicator */
    .nav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(10,12,18,0), rgba(10,12,18,.55) 30%, rgba(10,12,18,.88));
      backdrop-filter: blur(14px);
      z-index:50;
    }
    .navBar{
      height: 62px;
      border-radius: 20px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      display:flex;
      position:relative;
      overflow:hidden;
    }
    .navIndicator{
      position:absolute;
      top:8px; bottom:8px;
      left:8px;
      width: calc((100% - 16px) / 3);
      border-radius: 16px;
      background: radial-gradient(120px 70px at 50% 0%, rgba(74,163,255,.42), rgba(74,163,255,.14));
      border:1px solid rgba(74,163,255,.30);
      box-shadow: 0 16px 45px rgba(43,123,255,.18);
      z-index:0;
      transform: translateX(0);
    }
    .tabBtn{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      color: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:1;
    }
    .tabBtn svg{width:22px;height:22px}
    .tabBtn.active{ color: rgba(255,255,255,.96); }

    /* Pages */
    .page{display:none}
    .page.active{display:block}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding: 12px 12px calc(12px + var(--safeBottom));
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
      transform: translateY(12px);
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHead .h{
      font-weight:900;
      letter-spacing:1.1px;
      text-transform:uppercase;
      color: rgba(255,255,255,.84);
      font-size: 13px;
    }
    .xbtn{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }

    .casePreview{ padding: 12px 14px 0; text-align:center; }
    .bigImg{
      width: 100%;
      height: 190px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      display:grid; place-items:center;
      position:relative;
    }
    .bigImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .bigImg .ph{
      position:absolute; inset:0;
      display:grid; place-items:center;
      color: rgba(255,255,255,.55);
      font-weight:900;
      letter-spacing:.9px;
      text-transform:uppercase;
      font-size:12px;
    }
    .casePreview .name{
      margin: 12px 0 0;
      font-weight:950;
      font-size: 18px;
    }
    .casePreview .desc{
      margin: 6px 0 0;
      color: rgba(255,255,255,.65);
      font-size: 13px;
      line-height:1.35;
    }

    .chooser{ padding: 14px; display:flex; flex-direction:column; gap:12px; }
    .pillRow{ display:flex; gap:10px; justify-content:space-between; align-items:center; color: rgba(255,255,255,.85); font-weight:900; }
    .countPills{ display:flex; gap:10px; justify-content:space-between; }
    .pill{
      flex:1;
      height: 44px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      color: rgba(255,255,255,.78);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      background: radial-gradient(120px 70px at 50% 0%, rgba(74,163,255,.42), rgba(74,163,255,.14));
      border:1px solid rgba(74,163,255,.32);
      color: rgba(255,255,255,.95);
      box-shadow: 0 14px 40px rgba(43,123,255,.16);
    }

    .cta{ padding: 0 14px 14px; }
    .btn{
      width:100%;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(43,123,255,.95));
      color:#fff;
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(43,123,255,.22);
    }
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
      color: rgba(255,255,255,.90);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
    }

    /* Roulette (оставили аккуратно) */
    .rouletteWrap{
      margin: 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      position:relative;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
    }
    .rouletteTop{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.78);
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size: 12px;
    }
    .track{
      position:relative;
      height: 120px;
      overflow:hidden;
      background: rgba(0,0,0,.08);
    }
    .centerLine{
      position:absolute;
      top:10px; bottom:10px;
      left:50%;
      width: 3px;
      transform: translateX(-50%);
      background: rgba(74,163,255,.55);
      border-radius: 99px;
      z-index:5;
      box-shadow: 0 0 0 6px rgba(74,163,255,.08);
    }
    .reel{
      position:absolute;
      left:0; top:0;
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 14px;
      will-change: transform;
    }
    .itemChip{
      width: 100px;
      height: 90px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      flex: 0 0 auto;
      box-shadow: 0 12px 35px rgba(0,0,0,.32);
      overflow:hidden;
      position:relative;
    }
    /* место под фото гифта в рулетке */
    .chipImg{
      width: 52px; height: 44px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .chipImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .chipImg .ph{font-size:10px; color:rgba(255,255,255,.55); font-weight:900; text-transform:uppercase; letter-spacing:.7px}
    .itemChip .n{
      font-size: 11px;
      font-weight:900;
      color: rgba(255,255,255,.85);
      text-align:center;
      padding: 0 6px;
      line-height:1.05;
    }

    .resultToast{
      margin: 0 14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .resultToast.show{display:flex}
    .resultLeft{ display:flex; align-items:center; gap:10px; }
    .resultLeft .imgBox{
      width:44px;height:44px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .resultLeft .imgBox img{width:100%;height:100%;object-fit:cover;display:block;}
    .resultLeft .imgBox .ph{font-size:10px; color:rgba(255,255,255,.55); font-weight:900; text-transform:uppercase; letter-spacing:.7px}
    .resultLeft .t{ display:flex; flex-direction:column; gap:2px; }
    .resultLeft .t b{font-size:13px}
    .resultLeft .t span{font-size:12px; color:rgba(255,255,255,.65); display:flex; align-items:center; gap:6px}
    .tagWin{
      padding: 7px 10px;
      border-radius: 999px;
      font-weight:950;
      font-size: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      display:flex; align-items:center; gap:7px;
    }
    .tagWin.good{border-color: rgba(37,227,154,.30); background: rgba(37,227,154,.10)}
    .tagWin.bad{border-color: rgba(255,74,106,.28); background: rgba(255,74,106,.10)}

    /* Panels */
    .panel{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 24px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .note{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      line-height:1.35;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .rowSpace{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .sep{height:10px}
    .muted{color: rgba(255,255,255,.65)}

    /* Inventory: 2 в ряд + кнопки Продать/Вывести */
    .invGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    .giftCard{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 12px;
      box-shadow: 0 12px 35px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 190px;
    }
    .giftTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .giftImg{
      width: 64px; height: 64px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .giftImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .giftImg .ph{font-size:10px; color:rgba(255,255,255,.55); font-weight:900; text-transform:uppercase; letter-spacing:.7px}
    .giftMeta{min-width:0}
    .giftName{font-weight:950; font-size:12.5px; line-height:1.15; margin:0; color:rgba(255,255,255,.92)}
    .giftVal{
      margin-top:6px;
      font-weight:950;
      font-size:12px;
      color:rgba(255,255,255,.80);
      display:flex; align-items:center; gap:6px;
    }
    .giftQty{
      font-weight:950;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
      min-width: 54px;
      text-align:center;
      height: fit-content;
    }
    .giftActions{
      margin-top:auto;
      display:flex; gap:10px;
    }
    .smallBtn{
      flex:1;
      height: 40px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.90);
      font-weight:900;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
    }
    .smallBtn.primary{
      background: radial-gradient(120px 70px at 50% 0%, rgba(74,163,255,.45), rgba(74,163,255,.14));
      border:1px solid rgba(74,163,255,.30);
    }
    .smallBtn:active{transform: translateY(1px)}

    /* Upgrade layout (похоже на 4 фото) */
    .upgradeTitle{
      text-align:center;
      font-weight:950;
      letter-spacing:1.4px;
      text-transform:uppercase;
      color: rgba(255,255,255,.78);
      margin: 6px 0 14px;
      font-size: 13px;
    }
    .slots{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .slot{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 12px;
      min-height: 142px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .slot .label{
      font-size: 11px;
      font-weight:950;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .miniBtn{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
      font-weight:900;
      font-size: 11px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }

    .slotPick{
      margin-top:auto;
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .slotPick .img{
      width:52px;height:52px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .slotPick .img img{width:100%;height:100%;object-fit:cover;display:block;}
    .slotPick .img .ph{font-size:10px; color:rgba(255,255,255,.55); font-weight:900; text-transform:uppercase; letter-spacing:.7px}
    .slotPick .info{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .slotPick .info b{font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .slotPick .info span{font-size:12px; color:rgba(255,255,255,.65); display:flex; align-items:center; gap:6px}

    .upgradeMid{
      margin: 12px 0 0;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }

    /* Gauge + rotating pointer */
    .gauge{
      width: 150px; height: 150px;
      display:grid; place-items:center;
      position:relative;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 40%, rgba(74,163,255,.10), rgba(0,0,0,.18));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .gauge svg{display:block}
    .gauge .txt{
      position:absolute;
      display:flex; flex-direction:column; align-items:center; gap:2px;
      text-align:center;
      z-index:3;
    }
    .gauge .txt b{font-size: 18px}
    .gauge .txt span{font-size: 11px; color: rgba(255,255,255,.62); font-weight:900; letter-spacing:1.2px; text-transform:uppercase}

    /* pointer ring that spins */
    .pointerWrap{
      position:absolute; inset:10px;
      border-radius:999px;
      z-index:2;
      pointer-events:none;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }
    .pointer{
      position:absolute;
      left:50%; top:50%;
      width:2px; height:52px;
      transform-origin: bottom center;
      transform: translate(-50%,-100%) rotate(0deg);
      background: rgba(255,255,255,.85);
      border-radius: 99px;
    }
    .pointer::after{
      content:"";
      position:absolute;
      left:50%; top:-6px;
      width:10px;height:10px;border-radius:999px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      box-shadow: 0 0 0 5px rgba(74,163,255,.10);
    }

    .upgradeControls{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Picker sheet */
    .sheetOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:110;
      padding: 12px 12px calc(12px + var(--safeBottom));
    }
    .sheetOverlay.show{display:flex}
    .sheet{
      width:min(520px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .sheetHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheetHead b{
      font-size: 13px;
      font-weight:950;
      letter-spacing:1.1px;
      text-transform:uppercase;
      color: rgba(255,255,255,.82);
    }
    .sheetBody{
      max-height: 55vh;
      overflow:auto;
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .pickCard{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height: 118px;
    }
    .pickCard .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pickCard .img{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .pickCard .img img{width:100%;height:100%;object-fit:cover;display:block;}
    .pickCard .img .ph{font-size:10px; color:rgba(255,255,255,.55); font-weight:900; text-transform:uppercase; letter-spacing:.7px}
    .pickCard .nm{font-weight:950; font-size:12px; line-height:1.1; color:rgba(255,255,255,.92)}
    .pickCard .pr{font-weight:950; font-size:12px; color:rgba(255,255,255,.80); display:flex; align-items:center; gap:6px}
    .pickCard .sub{font-size:11px; color:rgba(255,255,255,.60)}
    .pickCard:active{transform: translateY(1px)}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(92px + var(--safeBottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      display:none;
      z-index:200;
      font-weight:800;
      font-size: 13px;
    }
    .toast.show{display:block}

    @media (min-width: 560px){
      .content{padding-left: 18px; padding-right:18px}
      .grid,.invGrid{gap:14px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="back" id="btnBack" title="Назад">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M14.5 6L8.5 12l6 6" stroke="rgba(255,255,255,.9)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="titleWrap">
        <p class="title">Gifts Battle</p>
        <p class="subtitle">мини-приложение</p>
      </div>

      <div class="wallet">
        <div class="plus" id="btnAddStars" title="Пополнить (демо)">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="balance"><span class="star"></span><span id="starsValue">45.4</span></div>
      </div>
    </div>

    <div class="content" id="scrollArea">
      <!-- HOME -->
      <div class="page active" id="pageHome">
        <div class="sectionTitle">LIMITED CASES</div>
        <div class="grid" id="casesGrid"></div>

        <div class="sep"></div>
        <div class="sectionTitle">SETUP</div>
        <div class="panel">
          <div class="note">
            • Ты вставляешь <b>картинки кейсов</b> и <b>картинки подарков</b> в объекте данных (<b>caseImg</b> / <b>img</b>).<br/>
            • Сейчас всё демо и хранится в <b>localStorage</b>.<br/>
            • Для окупа включена <b>подкрутка</b>: шанс на дорогие дропы снижен (но не до нуля).
          </div>
          <div class="sep"></div>
          <button class="btn ghost" id="btnDemoFill">Заполнить инвентарь (демо)</button>
        </div>
      </div>

      <!-- UPGRADE -->
      <div class="page" id="pageUpgrade">
        <div class="sectionTitle">UPGRADE NFT</div>

        <div class="panel">
          <div class="upgradeTitle">Апгрейд</div>

          <div class="slots">
            <div class="slot" id="slotFrom">
              <div class="label">
                <span>Подарок (апгрейдим)</span>
                <span class="miniBtn" id="pickFromBtn">Выбрать</span>
              </div>
              <div class="slotPick" id="fromPick"></div>
            </div>

            <div class="slot" id="slotTo">
              <div class="label">
                <span>Желаемый подарок</span>
                <span class="miniBtn" id="pickToBtn">Выбрать</span>
              </div>
              <div class="slotPick" id="toPick"></div>
            </div>
          </div>

          <div class="upgradeMid">
            <div class="gauge" aria-label="Шанс">
              <svg width="150" height="150" viewBox="0 0 150 150">
                <defs>
                  <filter id="softGlow">
                    <feGaussianBlur stdDeviation="2.2" result="blur"/>
                    <feMerge>
                      <feMergeNode in="blur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>
                <circle cx="75" cy="75" r="56" stroke="rgba(255,255,255,.12)" stroke-width="12" fill="none"/>
                <circle id="gaugeArc" cx="75" cy="75" r="56"
                        stroke="rgba(74,163,255,.95)" stroke-width="12"
                        stroke-linecap="round" fill="none"
                        stroke-dasharray="351.8584" stroke-dashoffset="351.8584"
                        transform="rotate(-90 75 75)" filter="url(#softGlow)"/>
              </svg>

              <div class="pointerWrap">
                <div class="pointer" id="upgradePointer"></div>
              </div>

              <div class="txt">
                <b id="chanceText">0%</b>
                <span>chance</span>
              </div>
            </div>

            <div class="upgradeControls">
              <div class="note" id="upgradeHint">
                Выбери <b>исходный</b> подарок из инвентаря и <b>цель</b> — появится шанс и кнопка.
              </div>
              <button class="btn" id="btnUpgrade" disabled>Апгрейд</button>
              <button class="btn ghost" id="btnResetUpgrade">Сбросить выбор</button>
            </div>
          </div>
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="page" id="pageInv">
        <div class="sectionTitle">INVENTORY</div>

        <div class="panel">
          <div class="rowSpace">
            <div class="note" style="flex:1">
              Подарки показываются по 2 в ряд. Можно <b>продать</b> (получить ★) или нажать <b>вывести</b> (демо).
            </div>
          </div>
          <div class="sep"></div>
          <div class="invGrid" id="invGrid"></div>
          <div class="sep"></div>
          <button class="btn ghost" id="btnClearInv">Очистить инвентарь</button>
        </div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <div class="nav">
      <div class="navBar" id="navBar">
        <div class="navIndicator" id="navIndicator"></div>

        <div class="tabBtn active" data-tab="home">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 11.2 12 4l8 7.2V20a1.8 1.8 0 0 1-1.8 1.8H5.8A1.8 1.8 0 0 1 4 20v-8.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9.5 21v-7.2h5V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Дом
        </div>

        <div class="tabBtn" data-tab="upgrade">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 2.8l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4-5.8-3.1-5.8 3.1 1.1-6.4-4.7-4.6 6.5-.9L12 2.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          Апгрейд
        </div>

        <div class="tabBtn" data-tab="inv">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 7.5h12l-1 13.2a1.7 1.7 0 0 1-1.7 1.6H8.7A1.7 1.7 0 0 1 7 20.7L6 7.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9 7.5V6a3 3 0 0 1 6 0v1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Инвентарь
        </div>
      </div>
    </div>
  </div>

  <!-- Case Modal -->
  <div class="modalOverlay" id="caseModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="h" id="modalHeader">CASE</div>
        <div class="xbtn" id="closeModal">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="casePreview">
        <div class="bigImg" id="modalBigImg">
          <div class="ph">CASE IMAGE</div>
          <img id="modalCaseImg" alt="" style="display:none" />
        </div>
        <div class="name" id="modalName">Case</div>
        <div class="desc" id="modalDesc">Открой кейс — крутни рулетку — получи подарок в инвентарь.</div>
      </div>

      <div class="chooser">
        <div class="pillRow">
          <div>How many cases to open?</div>
          <div class="muted"><span class="star"></span> <span id="modalPrice">55</span></div>
        </div>

        <div class="countPills" id="countPills">
          <div class="pill active" data-n="1">1</div>
          <div class="pill" data-n="2">2</div>
          <div class="pill" data-n="3">3</div>
          <div class="pill" data-n="4">4</div>
          <div class="pill" data-n="5">5</div>
        </div>
      </div>

      <div class="rouletteWrap">
        <div class="rouletteTop">
          <span>roulette</span>
          <span class="muted" id="rouletteHint">Нажми “Open case”</span>
        </div>
        <div class="track">
          <div class="centerLine"></div>
          <div class="reel" id="reel"></div>
        </div>
      </div>

      <div class="resultToast" id="resultToast">
        <div class="resultLeft">
          <div class="imgBox" id="resImgBox">
            <div class="ph">GIFT</div>
            <img id="resImg" alt="" style="display:none" />
          </div>
          <div class="t">
            <b id="resName">Gift</b>
            <span><span class="star"></span><span id="resValue">0</span> • добавлено в инвентарь</span>
          </div>
        </div>
        <div class="tagWin good" id="resTag"><span>✔</span><span>WIN</span></div>
      </div>

      <div class="cta">
        <button class="btn" id="btnOpenCase"><span>Open case</span> <span class="star"></span><span id="btnCost">55</span></button>
        <div class="sep"></div>
        <button class="btn ghost" id="btnShowContents">Показать содержимое кейса</button>
      </div>
    </div>
  </div>

  <!-- Picker Sheet -->
  <div class="sheetOverlay" id="pickerOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <b id="pickerTitle">Выбери подарок</b>
        <div class="xbtn" id="pickerClose">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
      <div class="sheetBody" id="pickerBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">Сообщение</div>

  <script>
    /********************
     * Telegram init
     ********************/
    const tg = window.Telegram?.WebApp;
    try{
      tg?.ready();
      tg?.expand();
    }catch(e){}

    /********************
     * STORAGE
     ********************/
    const STORAGE = {
      stars: "gb_demo_stars",
      inv:   "gb_demo_inventory"
    };

    /********************
     * DATA: вставляй картинки здесь
     *  - gift.img  : URL/путь к картинке подарка
     *  - case.caseImg : URL/путь к картинке кейса
     ********************/
    const GIFTS = [
      { id:"pin",   name:"Telegram Pin",               value:3000, img:"" },
      { id:"lock",  name:"Heart Locket Telegram",      value:1799, img:"" },
      { id:"cap",   name:"Durov’s Cap Classic",        value:775,  img:"" },
      { id:"peach", name:"Precious Peach Airy Bright", value:480,  img:"" },
      { id:"ring",  name:"Shiny Ring",                 value:260,  img:"" },
      { id:"candle",name:"B-Day Candle (Random)",      value:149,  img:"" },
      { id:"jack",  name:"Jack-in-the-Box Minifigure", value:231,  img:"" },
      { id:"muscle",name:"Power Arm",                  value:120,  img:"" },
      { id:"plane", name:"Paper Plane Charm",          value:85,   img:"" },
      { id:"duck",  name:"Little Duck",                value:55,   img:"" },
      { id:"cookie",name:"Lucky Cookie",               value:35,   img:"" },
      { id:"gem",   name:"Blue Gem",                   value:462,  img:"" },
      { id:"watch", name:"Golden Watch",               value:980,  img:"" },
      { id:"bear",  name:"Soft Toy",                   value:90,   img:"" }
    ];

    const CASES = [
      {
        id:"durov_mining",
        title:"Durov Mining",
        price:272,
        badge:"LIMITED",
        caseImg:"",
        desc:"Лимитный кейс с шансом на редкости.",
        pool: [
          { gift:"cap", w:12 },
          { gift:"peach", w:18 },
          { gift:"ring", w:18 },
          { gift:"duck", w:22 },
          { gift:"cookie", w:30 },
          { gift:"lock", w:7 },
          { gift:"watch", w:4 },
          { gift:"pin", w:2 }
        ]
      },
      {
        id:"champion",
        title:"Champion",
        price:452,
        badge:"LIMITED",
        caseImg:"",
        desc:"Повыше цена — вкуснее лут.",
        pool: [
          { gift:"candle", w:22 },
          { gift:"jack", w:16 },
          { gift:"gem", w:12 },
          { gift:"lock", w:10 },
          { gift:"watch", w:6 },
          { gift:"pin", w:2 },
          { gift:"cap", w:12 },
          { gift:"peach", w:20 }
        ]
      },
      {
        id:"cemetery",
        title:"The Cemetery of Secrets",
        price:1104,
        badge:"LIMITED",
        caseImg:"",
        big:true,
        desc:"Дорогой кейс с “тяжёлыми” подарками.",
        pool: [
          { gift:"pin", w:4 },
          { gift:"lock", w:10 },
          { gift:"watch", w:10 },
          { gift:"gem", w:12 },
          { gift:"cap", w:14 },
          { gift:"peach", w:18 },
          { gift:"ring", w:16 },
          { gift:"candle", w:16 }
        ]
      },
      {
        id:"pepe_all_in",
        title:"PEPE ALL IN",
        price:55,
        badge:"HOT",
        caseImg:"",
        desc:"Бюджетный кейс, быстрые спины.",
        pool: [
          { gift:"cookie", w:35 },
          { gift:"duck", w:25 },
          { gift:"plane", w:18 },
          { gift:"muscle", w:12 },
          { gift:"ring", w:7 },
          { gift:"cap", w:3 }
        ]
      }
    ];

    /********************
     * HOUSE EDGE / "подкрутка"
     * Можно менять, чтобы регулировать окуп.
     ********************/
    const HOUSE = {
      // общий даунскейл дорогих дропов в кейсах:
      caseRigStrength: 0.45,   // 0..1 (выше = сильнее подкрутка)
      // шанс апгрейда режем:
      upgradeEdge: 0.86,       // множитель к честному шансу
      // минимальный шанс в апгрейде:
      upgradeMin: 1.0,
      // максимум:
      upgradeMax: 92,
      // продажа в инвентаре (сколько % от value возвращаем)
      sellReturn: 0.72
    };

    /********************
     * STATE
     ********************/
    let stars = loadNumber(STORAGE.stars, 45.4);
    let inventory = loadJSON(STORAGE.inv, {}); // {giftId: qty}

    let currentCase = CASES[3];
    let openCount = 1;

    let upgradeFrom = null;
    let upgradeTo   = null;

    /********************
     * DOM
     ********************/
    const starsValue  = document.getElementById("starsValue");
    const casesGrid   = document.getElementById("casesGrid");

    const pages = {
      home: document.getElementById("pageHome"),
      upgrade: document.getElementById("pageUpgrade"),
      inv: document.getElementById("pageInv")
    };

    // nav
    const navIndicator = document.getElementById("navIndicator");

    // modal
    const caseModal      = document.getElementById("caseModal");
    const closeModal     = document.getElementById("closeModal");
    const modalHeader    = document.getElementById("modalHeader");
    const modalName      = document.getElementById("modalName");
    const modalDesc      = document.getElementById("modalDesc");
    const modalPrice     = document.getElementById("modalPrice");
    const btnCost        = document.getElementById("btnCost");
    const btnOpenCase    = document.getElementById("btnOpenCase");
    const btnShowContents= document.getElementById("btnShowContents");
    const countPills     = document.getElementById("countPills");
    const reel           = document.getElementById("reel");
    const rouletteHint   = document.getElementById("rouletteHint");
    const resultToast    = document.getElementById("resultToast");
    const resName        = document.getElementById("resName");
    const resValue       = document.getElementById("resValue");
    const resTag         = document.getElementById("resTag");
    const modalCaseImg   = document.getElementById("modalCaseImg");
    const modalBigImg    = document.getElementById("modalBigImg");
    const resImg         = document.getElementById("resImg");
    const resImgBox      = document.getElementById("resImgBox");

    // inventory
    const invGrid  = document.getElementById("invGrid");

    // upgrade
    const pickFromBtn  = document.getElementById("pickFromBtn");
    const pickToBtn    = document.getElementById("pickToBtn");
    const fromPick     = document.getElementById("fromPick");
    const toPick       = document.getElementById("toPick");
    const btnUpgrade   = document.getElementById("btnUpgrade");
    const btnResetUpgrade = document.getElementById("btnResetUpgrade");
    const upgradeHint  = document.getElementById("upgradeHint");
    const gaugeArc     = document.getElementById("gaugeArc");
    const chanceText   = document.getElementById("chanceText");
    const upgradePointer = document.getElementById("upgradePointer");

    // picker
    const pickerOverlay = document.getElementById("pickerOverlay");
    const pickerTitle   = document.getElementById("pickerTitle");
    const pickerBody    = document.getElementById("pickerBody");
    const pickerClose   = document.getElementById("pickerClose");

    // misc
    const toast = document.getElementById("toast");

    /********************
     * INIT
     ********************/
    renderStars();
    renderCases();
    renderInventory();
    renderUpgrade();
    buildReel(currentCase);
    updateModalPrice();

    // entrance
    gsap.fromTo(".topbar", {y:-12, opacity:0}, {y:0, opacity:1, duration:.5, ease:"power2.out"});
    gsap.fromTo(".navBar", {y:14, opacity:0}, {y:0, opacity:1, duration:.55, ease:"power2.out", delay:.05});

    // pointer idle spin
    let pointerSpin = gsap.to(upgradePointer, {rotation:360, duration:2.2, ease:"linear", repeat:-1});
    pointerSpin.pause(); // включим только когда есть выбор

    // nav indicator set
    moveIndicatorToTab("home", false);

    /********************
     * TOP actions
     ********************/
    document.getElementById("btnBack").addEventListener("click", ()=>{
      if(tg?.BackButton){
        tg.close();
      }else{
        showToast("Демо. В Mini App кнопка Назад закрывает приложение.");
      }
    });

    document.getElementById("btnAddStars").addEventListener("click", ()=>{
      stars = round1(stars + 20);
      saveNumber(STORAGE.stars, stars);
      renderStars();
      pulse(".wallet");
      showToast("Демо: +20★ добавлено");
    });

    document.getElementById("btnDemoFill").addEventListener("click", ()=>{
      addToInv("candle", 2);
      addToInv("jack", 1);
      addToInv("cap", 1);
      addToInv("peach", 1);
      addToInv("duck", 4);
      renderInventory();
      showToast("Инвентарь заполнен (демо)");
    });

    /********************
     * TABS + indicator
     ********************/
    document.querySelectorAll(".tabBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setTab(btn.dataset.tab);
      });
    });

    function setTab(tab){
      document.querySelectorAll(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      Object.values(pages).forEach(p=>p.classList.remove("active"));

      if(tab==="home") pages.home.classList.add("active");
      if(tab==="upgrade") pages.upgrade.classList.add("active");
      if(tab==="inv") pages.inv.classList.add("active");

      const pageEl = tab==="home"?pages.home:tab==="upgrade"?pages.upgrade:pages.inv;
      gsap.fromTo(pageEl, {opacity:0, y:10}, {opacity:1, y:0, duration:.28, ease:"power2.out"});
      document.getElementById("scrollArea").scrollTop = 0;

      moveIndicatorToTab(tab, true);

      renderInventory();
      renderUpgrade();
    }

    function moveIndicatorToTab(tab, animate=true){
      const idx = tab==="home" ? 0 : tab==="upgrade" ? 1 : 2;
      const navBar = document.getElementById("navBar");
      const w = (navBar.clientWidth - 16) / 3; // indicator width
      const x = 8 + idx * w;
      if(animate){
        gsap.to(navIndicator, {x: x - 8, duration:.28, ease:"power2.out"}); // because left already 8px
      }else{
        gsap.set(navIndicator, {x: x - 8});
      }
    }

    window.addEventListener("resize", ()=>{
      const active = document.querySelector(".tabBtn.active")?.dataset.tab || "home";
      moveIndicatorToTab(active, false);
    });

    /********************
     * CASES grid
     ********************/
    function renderCases(){
      casesGrid.innerHTML = "";
      const order = [CASES[0], CASES[1], CASES[2], CASES[3]];

      order.forEach(c=>{
        const el = document.createElement("div");
        el.className = "caseCard" + (c.big ? " bigCard" : "");
        el.innerHTML = `
          <div class="badge"><span class="dot"></span>${escapeHtml(c.badge)}</div>
          <div class="caseHero">
            <div class="caseImg">
              ${c.caseImg ? `<img src="${escapeAttr(c.caseImg)}" alt="${escapeAttr(c.title)}" />` : `<div class="ph">CASE IMAGE</div>`}
            </div>
          </div>
          <div class="caseMeta">
            <div class="caseName">${escapeHtml(c.title)}</div>
            <div class="priceRow"><span class="star"></span><span>${formatStars(c.price)}</span></div>
          </div>
        `;
        el.addEventListener("click", ()=> openCaseModal(c));

        el.addEventListener("pointerdown", ()=> gsap.to(el, {scale:0.985, duration:.12, ease:"power2.out"}));
        el.addEventListener("pointerup", ()=> gsap.to(el, {scale:1, duration:.18, ease:"power2.out"}));
        el.addEventListener("pointerleave", ()=> gsap.to(el, {scale:1, duration:.18, ease:"power2.out"}));

        casesGrid.appendChild(el);
      });
    }

    /********************
     * MODAL
     ********************/
    closeModal.addEventListener("click", hideModal);
    caseModal.addEventListener("click", (e)=>{ if(e.target === caseModal) hideModal(); });

    countPills.addEventListener("click", (e)=>{
      const pill = e.target.closest(".pill");
      if(!pill) return;
      openCount = Number(pill.dataset.n || "1");
      [...countPills.querySelectorAll(".pill")].forEach(p=>p.classList.toggle("active", p===pill));
      updateModalPrice();
      pulse(".countPills");
    });

    btnShowContents.addEventListener("click", ()=>{
      const content = currentCase.pool
        .map(p=>{
          const g = getGift(p.gift);
          return `• ${g.name} (${g.value}★)`;
        }).join("\n");
      alert("Содержимое кейса (демо):\n\n" + content);
    });

    btnOpenCase.addEventListener("click", async ()=>{
      const totalCost = currentCase.price * openCount;
      if(stars + 1e-9 < totalCost){
        showToast("Не хватает ★. Нажми + чтобы пополнить (демо).");
        wiggle(".wallet");
        return;
      }

      stars = round1(stars - totalCost);
      saveNumber(STORAGE.stars, stars);
      renderStars();

      btnOpenCase.disabled = true;
      rouletteHint.textContent = "Крутим…";
      resultToast.classList.remove("show");

      for(let i=0;i<openCount;i++){
        // подкрутка дропов
        const wonGiftId = riggedPick(currentCase.pool);
        const won = getGift(wonGiftId);

        await spinTo(wonGiftId, currentCase);

        addToInv(wonGiftId, 1);
        renderInventory();

        // result UI
        resName.textContent = won.name;
        resValue.textContent = formatStars(won.value);

        setImgOrPlaceholder(resImg, resImgBox, won.img, "GIFT");

        resTag.className = "tagWin good";
        resTag.innerHTML = `<span>✔</span><span>WIN</span>`;
        resultToast.classList.add("show");
        gsap.fromTo(resultToast, {y:10, opacity:0}, {y:0, opacity:1, duration:.22, ease:"power2.out"});

        if(i < openCount-1){
          await sleep(420);
          resultToast.classList.remove("show");
          rouletteHint.textContent = `Ещё ${openCount-1-i}…`;
          await sleep(220);
        }
      }

      rouletteHint.textContent = "Готово ✅";
      btnOpenCase.disabled = false;
      pulse(".resultToast");
    });

    function openCaseModal(c){
      currentCase = c;
      openCount = 1;

      [...countPills.querySelectorAll(".pill")].forEach((p,idx)=>p.classList.toggle("active", idx===0));
      modalHeader.textContent = c.title.toUpperCase();
      modalName.textContent = c.title;
      modalDesc.textContent = c.desc;

      setImgOrPlaceholder(modalCaseImg, modalBigImg, c.caseImg, "CASE IMAGE");

      buildReel(c);
      updateModalPrice();
      rouletteHint.textContent = "Нажми “Open case”";
      resultToast.classList.remove("show");

      caseModal.classList.add("show");
      gsap.fromTo(".modal", {y:20, opacity:0}, {y:0, opacity:1, duration:.26, ease:"power2.out"});
      pulse(".modal");
    }

    function hideModal(){
      gsap.to(".modal", {y:20, opacity:0, duration:.16, ease:"power2.in", onComplete:()=>{
        caseModal.classList.remove("show");
        gsap.set(".modal", {clearProps:"all"});
      }});
    }

    function updateModalPrice(){
      const total = currentCase.price * openCount;
      modalPrice.textContent = formatStars(total);
      btnCost.textContent = formatStars(total);
    }

    /********************
     * ROULETTE
     ********************/
    function buildReel(caseObj){
      reel.innerHTML = "";

      const base = [];
      caseObj.pool.forEach(p=>{
        const g = getGift(p.gift);
        for(let k=0;k<Math.max(1, Math.round(p.w/8));k++) base.push(g);
      });

      const strip = [];
      for(let i=0;i<60;i++){
        strip.push(base[randInt(0, base.length-1)]);
      }

      strip.forEach(g=>{
        const chip = document.createElement("div");
        chip.className = "itemChip";
        chip.dataset.gift = g.id;
        chip.innerHTML = `
          <div class="chipImg">
            ${g.img ? `<img src="${escapeAttr(g.img)}" alt="${escapeAttr(g.name)}" />` : `<div class="ph">GIFT</div>`}
          </div>
          <div class="n">${escapeHtml(shortName(g.name))}</div>
        `;
        reel.appendChild(chip);
      });

      gsap.set(reel, {x:0});
    }

    async function spinTo(giftId, caseObj){
      buildReel(caseObj);

      const chips = [...reel.querySelectorAll(".itemChip")];
      const targetIndex = randInt(38, 52);

      const g = getGift(giftId);
      chips[targetIndex].dataset.gift = giftId;
      chips[targetIndex].innerHTML = `
        <div class="chipImg">
          ${g.img ? `<img src="${escapeAttr(g.img)}" alt="${escapeAttr(g.name)}" />` : `<div class="ph">GIFT</div>`}
        </div>
        <div class="n">${escapeHtml(shortName(g.name))}</div>
      `;

      const chipW = 110;
      const containerW = document.querySelector(".track").clientWidth;
      const centerX = containerW / 2;
      const leftPadding = 14;
      const targetX = leftPadding + targetIndex * chipW + 50;
      const finalX = centerX - targetX;

      const dur = 2.1 + Math.random()*0.6;
      const overshoot = finalX - (35 + Math.random()*45);

      gsap.set(reel, {x: 18});
      await sleep(50);

      await gsapToPromise(reel, {x: overshoot, duration: dur, ease:"power3.out"});
      await gsapToPromise(reel, {x: finalX, duration: .52, ease:"elastic.out(1, 0.35)"});

      const winChip = chips[targetIndex];
      gsap.fromTo(winChip, {scale:1}, {scale:1.06, duration:.16, yoyo:true, repeat:1, ease:"power2.out"});
      pulse(".centerLine");
    }

    /********************
     * Inventory (2 в ряд + продать/вывести)
     ********************/
    function renderInventory(){
      saveJSON(STORAGE.inv, inventory);

      const entries = Object.entries(inventory)
        .filter(([_,qty])=>qty>0)
        .map(([id,qty])=>({ ...getGift(id), qty }))
        .sort((a,b)=> b.value - a.value);

      if(entries.length===0){
        invGrid.innerHTML = `<div class="note" style="grid-column:span 2">Пусто. Открой кейс на вкладке “Дом”.</div>`;
        return;
      }

      invGrid.innerHTML = "";
      entries.forEach(it=>{
        const el = document.createElement("div");
        el.className = "giftCard";

        const sellBack = Math.max(1, Math.floor(it.value * HOUSE.sellReturn)); // окуп/комиссия
        el.innerHTML = `
          <div class="giftTop">
            <div class="giftImg" data-imgwrap>
              ${it.img ? `<img src="${escapeAttr(it.img)}" alt="${escapeAttr(it.name)}" />` : `<div class="ph">GIFT</div>`}
            </div>
            <div class="giftQty">x${it.qty}</div>
          </div>

          <div class="giftMeta">
            <p class="giftName">${escapeHtml(it.name)}</p>
            <div class="giftVal"><span class="star"></span>${formatStars(it.value)} <span class="muted">• sell: ${sellBack}★</span></div>
          </div>

          <div class="giftActions">
            <button class="smallBtn" data-act="sell">Продать</button>
            <button class="smallBtn primary" data-act="withdraw">Вывести</button>
          </div>
        `;

        el.querySelector('[data-act="sell"]').addEventListener("click", ()=>{
          if((inventory[it.id]||0) <= 0) return;
          removeFromInv(it.id, 1);
          stars = round1(stars + sellBack);
          saveNumber(STORAGE.stars, stars);
          renderStars();
          renderInventory();
          showToast(`Продано: +${sellBack}★`);
          pulse(".wallet");
        });

        el.querySelector('[data-act="withdraw"]').addEventListener("click", ()=>{
          // демо вывод
          showToast("Вывод (демо): в реальном проекте тут будет API/бот");
          pulse(el);
        });

        invGrid.appendChild(el);
      });
    }

    document.getElementById("btnClearInv").addEventListener("click", ()=>{
      if(!confirm("Очистить инвентарь?")) return;
      inventory = {};
      saveJSON(STORAGE.inv, inventory);
      upgradeFrom = null;
      upgradeTo = null;
      renderInventory();
      renderUpgrade();
      showToast("Инвентарь очищен");
    });

    function addToInv(giftId, qty){
      inventory[giftId] = (inventory[giftId]||0) + qty;
      saveJSON(STORAGE.inv, inventory);
    }
    function removeFromInv(giftId, qty){
      const cur = inventory[giftId] || 0;
      const next = Math.max(0, cur - qty);
      inventory[giftId] = next;
      saveJSON(STORAGE.inv, inventory);
    }

    /********************
     * Upgrade
     ********************/
    pickFromBtn.addEventListener("click", ()=> openPickerFromInventory());
    pickToBtn.addEventListener("click", ()=> openPickerFromCatalog());

    btnResetUpgrade.addEventListener("click", ()=>{
      upgradeFrom = null;
      upgradeTo = null;
      renderUpgrade();
      showToast("Выбор сброшен");
    });

    btnUpgrade.addEventListener("click", async ()=>{
      const chance = calcChance();
      if(!upgradeFrom || !upgradeTo || chance<=0){
        wiggle("#upgradeHint");
        showToast("Выбери исходный и цель");
        return;
      }
      if((inventory[upgradeFrom]||0) <= 0){
        showToast("В инвентаре нет исходного подарка");
        renderUpgrade();
        return;
      }

      btnUpgrade.disabled = true;

      // крутится стрелка, потом "попало/нет"
      pointerSpin.play();

      // определяем результат (с подкруткой уже в chance)
      const roll = Math.random()*100;
      const success = roll < chance;

      // делаем "докрут" в нужный сектор: зелёный/красный
      // Зеленый сектор: около 30°..110°, Красный: около 200°..300°
      const targetDeg = success
        ? randInt(30, 110)
        : randInt(200, 300);

      // тормозим красиво: несколько оборотов + попадание
      const currentRot = gsap.getProperty(upgradePointer, "rotation") || 0;
      const extra = 360 * randInt(2,4);
      const finalRot = Math.round(currentRot/360)*360 + extra + targetDeg;

      await gsapToPromise(upgradePointer, {rotation: finalRot, duration: 1.25, ease:"power3.out"});
      pointerSpin.pause();

      // расходуем 1 исходный
      removeFromInv(upgradeFrom, 1);

      if(success){
        addToInv(upgradeTo, 1);
        showToast("Успех! Подарок добавлен ✅");
        // эффект победы
        gsap.fromTo("#slotTo", {scale:1}, {scale:1.03, duration:.18, yoyo:true, repeat:1, ease:"power2.out"});
        confettiBurst();
      }else{
        showToast("Неудача… подарок сгорел ❌");
        gsap.fromTo("#slotFrom", {x:0}, {x:8, duration:.06, yoyo:true, repeat:5, ease:"power1.inOut"});
      }

      renderInventory();

      if((inventory[upgradeFrom]||0) <= 0) upgradeFrom = null;

      btnUpgrade.disabled = false;
      renderUpgrade();
    });

    function renderUpgrade(){
      // from
      if(upgradeFrom){
        const g = getGift(upgradeFrom);
        const qty = inventory[upgradeFrom] || 0;
        fromPick.innerHTML = `
          <div class="img">
            ${g.img ? `<img src="${escapeAttr(g.img)}" alt="${escapeAttr(g.name)}" />` : `<div class="ph">GIFT</div>`}
          </div>
          <div class="info">
            <b>${escapeHtml(g.name)}</b>
            <span><span class="star"></span>${formatStars(g.value)} • <span class="muted">x${qty}</span></span>
          </div>
        `;
      }else{
        fromPick.innerHTML = `
          <div class="img"><div class="ph">PICK</div></div>
          <div class="info">
            <b>Не выбран</b>
            <span class="muted">Выбери из инвентаря</span>
          </div>
        `;
      }

      // to
      if(upgradeTo){
        const g = getGift(upgradeTo);
        toPick.innerHTML = `
          <div class="img">
            ${g.img ? `<img src="${escapeAttr(g.img)}" alt="${escapeAttr(g.name)}" />` : `<div class="ph">GIFT</div>`}
          </div>
          <div class="info">
            <b>${escapeHtml(g.name)}</b>
            <span><span class="star"></span>${formatStars(g.value)} • <span class="muted">цель</span></span>
          </div>
        `;
      }else{
        toPick.innerHTML = `
          <div class="img"><div class="ph">GOAL</div></div>
          <div class="info">
            <b>Не выбран</b>
            <span class="muted">Выбери цель</span>
          </div>
        `;
      }

      const chance = calcChance();
      setGauge(chance);

      if(upgradeFrom && upgradeTo){
        upgradeHint.innerHTML = `Шанс (с учётом комиссии/окупа): <b>${chance.toFixed(2)}%</b>.`;
        btnUpgrade.disabled = false;
        pointerSpin.play();
      }else{
        upgradeHint.innerHTML = `Выбери <b>исходный</b> подарок из инвентаря и <b>цель</b> — появится шанс и кнопка.`;
        btnUpgrade.disabled = true;
        pointerSpin.pause();
      }
    }

    function calcChance(){
      if(!upgradeFrom || !upgradeTo) return 0;
      const a = getGift(upgradeFrom).value;
      const b = getGift(upgradeTo).value;
      if(b <= 0) return 0;

      // честная база
      let raw = (a / b) * 100;

      // если апгрейд "вниз" — почти гарант, но не 100
      if(a >= b){
        raw = clamp(90 + (a-b)/Math.max(1,b)*8, 90, 97.5);
      }

      // house edge
      raw *= HOUSE.upgradeEdge;

      // дополнительно режем высокие цели (чуть-чуть)
      const t = b;
      if(t >= 1000) raw *= 0.92;
      else if(t >= 500) raw *= 0.95;

      raw = clamp(raw, HOUSE.upgradeMin, HOUSE.upgradeMax);
      return raw;
    }

    function setGauge(percent){
      const C = 351.8584; // 2*pi*r (r=56)
      const off = C * (1 - percent/100);
      gaugeArc.style.strokeDashoffset = String(off);
      chanceText.textContent = `${percent.toFixed(2)}%`;

      if(percent >= 60){
        gaugeArc.style.stroke = "rgba(37,227,154,.95)";
      }else if(percent >= 25){
        gaugeArc.style.stroke = "rgba(74,163,255,.95)";
      }else{
        gaugeArc.style.stroke = "rgba(255,74,106,.92)";
      }
    }

    /********************
     * Picker
     ********************/
    function openPickerFromInventory(){
      const list = Object.entries(inventory).filter(([id,qty])=>qty>0);
      if(list.length===0){
        showToast("Инвентарь пуст");
        setTab("home");
        return;
      }

      pickerTitle.textContent = "Выбери исходный";
      pickerBody.innerHTML = "";
      list
        .map(([id,qty])=>({ ...getGift(id), qty }))
        .sort((a,b)=>b.value-a.value)
        .forEach(g=>{
          const el = document.createElement("div");
          el.className = "pickCard";
          el.innerHTML = `
            <div class="row">
              <div class="img">${g.img ? `<img src="${escapeAttr(g.img)}" alt="${escapeAttr(g.name)}" />` : `<div class="ph">GIFT</div>`}</div>
              <div class="pr">x${g.qty}</div>
            </div>
            <div class="nm">${escapeHtml(g.name)}</div>
            <div class="sub"><span class="star"></span>${formatStars(g.value)}</div>
          `;
          el.addEventListener("click", ()=>{
            upgradeFrom = g.id;
            closePicker();
            renderUpgrade();
            pulse("#slotFrom");
          });
          pickerBody.appendChild(el);
        });

      openPicker();
    }

    function openPickerFromCatalog(){
      pickerTitle.textContent = "Выбери цель";
      pickerBody.innerHTML = "";
      GIFTS.slice().sort((a,b)=>b.value-a.value).forEach(g=>{
        const el = document.createElement("div");
        el.className = "pickCard";
        el.innerHTML = `
          <div class="row">
            <div class="img">${g.img ? `<img src="${escapeAttr(g.img)}" alt="${escapeAttr(g.name)}" />` : `<div class="ph">GIFT</div>`}</div>
            <div class="pr"><span class="star"></span>${formatStars(g.value)}</div>
          </div>
          <div class="nm">${escapeHtml(g.name)}</div>
          <div class="sub">id: ${escapeHtml(g.id)}</div>
        `;
        el.addEventListener("click", ()=>{
          upgradeTo = g.id;
          closePicker();
          renderUpgrade();
          pulse("#slotTo");
        });
        pickerBody.appendChild(el);
      });
      openPicker();
    }

    function openPicker(){
      pickerOverlay.classList.add("show");
      gsap.fromTo(".sheet", {y:20, opacity:0}, {y:0, opacity:1, duration:.24, ease:"power2.out"});
    }
    function closePicker(){
      gsap.to(".sheet", {y:20, opacity:0, duration:.14, ease:"power2.in", onComplete:()=>{
        pickerOverlay.classList.remove("show");
        gsap.set(".sheet", {clearProps:"all"});
      }});
    }
    pickerClose.addEventListener("click", closePicker);
    pickerOverlay.addEventListener("click", (e)=>{ if(e.target === pickerOverlay) closePicker(); });

    /********************
     * RIGGED pick for cases
     * Идея: сначала обычный weightedPick, потом если подарок дорогой —
     * шанс "переброса" увеличивается.
     ********************/
    function riggedPick(pool){
      const first = weightedPick(pool);
      const g = getGift(first);
      const v = g.value || 0;

      // чем дороже, тем выше шанс переброса
      let rerollChance = 0;

      if(v >= 2500) rerollChance = 0.70;
      else if(v >= 1500) rerollChance = 0.55;
      else if(v >= 900)  rerollChance = 0.40;
      else if(v >= 450)  rerollChance = 0.28;
      else rerollChance = 0.10;

      // общая сила подкрутки
      rerollChance *= HOUSE.caseRigStrength;

      if(Math.random() < rerollChance){
        // перебрасываем в сторону "дешевле":
        // выбираем из подмножества: value <= текущего или <= порога
        const cheaper = pool
          .map(p=>p.gift)
          .filter(id => getGift(id).value <= Math.max(1, v * 0.72));

        if(cheaper.length){
          // равновероятно из дешёвых (можно усложнить)
          return cheaper[randInt(0, cheaper.length-1)];
        }
      }
      return first;
    }

    function weightedPick(pool){
      const sum = pool.reduce((s,p)=>s+p.w,0);
      let r = Math.random()*sum;
      for(const p of pool){
        r -= p.w;
        if(r <= 0) return p.gift;
      }
      return pool[pool.length-1].gift;
    }

    /********************
     * Helpers
     ********************/
    function getGift(id){
      return GIFTS.find(g=>g.id===id) || {id, name:"Unknown", value:0, img:""};
    }

    function renderStars(){
      starsValue.textContent = formatStars(stars);
    }

    function formatStars(n){
      const x = Number(n);
      if(Number.isNaN(x)) return String(n);
      if(Math.abs(x - Math.round(x)) < 1e-9) return String(Math.round(x));
      return x.toFixed(1);
    }
    function round1(x){ return Math.round(x*10)/10; }

    function loadNumber(key, fallback){
      const v = localStorage.getItem(key);
      if(v===null || v===undefined) return fallback;
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function saveNumber(key, val){ localStorage.setItem(key, String(val)); }
    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if(!v) return fallback;
        return JSON.parse(v);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function gsapToPromise(target, vars){
      return new Promise(res=> gsap.to(target, {...vars, onComplete: res}));
    }
    function shortName(name){
      const n = String(name);
      return n.length > 14 ? n.slice(0, 13) + "…" : n;
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    function pulse(selOrEl){
      const el = typeof selOrEl === "string" ? document.querySelector(selOrEl) : selOrEl;
      if(!el) return;
      gsap.fromTo(el, {scale:1}, {scale:1.015, duration:.14, yoyo:true, repeat:1, ease:"power2.out"});
    }
    function wiggle(sel){
      const el = document.querySelector(sel);
      if(!el) return;
      gsap.fromTo(el, {x:0}, {x:7, duration:.06, yoyo:true, repeat:5, ease:"power1.inOut"});
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      gsap.fromTo(toast, {y:10, opacity:0}, {y:0, opacity:1, duration:.18, ease:"power2.out"});
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{
        gsap.to(toast, {y:10, opacity:0, duration:.16, ease:"power2.in", onComplete:()=>toast.classList.remove("show")});
      }, 1750);
    }

    function setImgOrPlaceholder(imgEl, wrapEl, url, label){
      // wrapEl содержит placeholder div.ph
      const ph = wrapEl.querySelector(".ph");
      if(url && String(url).trim().length){
        imgEl.src = url;
        imgEl.style.display = "block";
        if(ph) ph.style.display = "none";
      }else{
        imgEl.removeAttribute("src");
        imgEl.style.display = "none";
        if(ph){
          ph.textContent = label || "IMAGE";
          ph.style.display = "grid";
        }
      }
    }

    function confettiBurst(){
      const n = 16;
      for(let i=0;i<n;i++){
        const p = document.createElement("div");
        p.style.position="fixed";
        p.style.left = (window.innerWidth/2 + randInt(-60,60)) + "px";
        p.style.top  = (window.innerHeight/2 + randInt(-140,-20)) + "px";
        p.style.width="8px";
        p.style.height="8px";
        p.style.borderRadius = "3px";
        p.style.background = `rgba(${randInt(60,255)},${randInt(80,255)},${randInt(160,255)},.95)`;
        p.style.boxShadow = "0 10px 30px rgba(0,0,0,.35)";
        p.style.zIndex = 300;
        document.body.appendChild(p);

        const dx = randInt(-160,160);
        const dy = randInt(120,220);
        gsap.to(p, {x:dx, y:dy, rotation:randInt(-240,240), opacity:0, duration:0.85+Math.random()*0.45, ease:"power2.out", onComplete:()=>p.remove()});
      }
    }

    /********************
     * storage sync
     ********************/
    window.addEventListener("storage", ()=>{
      inventory = loadJSON(STORAGE.inv, {});
      if(upgradeFrom && (inventory[upgradeFrom]||0) <= 0) upgradeFrom = null;
      renderInventory();
      renderUpgrade();
    });
  </script>
</body>
</html>
