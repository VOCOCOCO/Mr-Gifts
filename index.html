<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Gifts Cases ‚Äî Home / Upgrade / Inventory</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <style>
    :root{
      --bg0:#06080d;
      --bg1:#0a0f1b;

      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);

      --text:#eef5ff;
      --muted:#a7b8d9;

      --blue:#4aa3ff;
      --blue2:#2b7bff;
      --green:#25e39a;
      --red:#ff4a6a;
      --gold:#ffd56a;

      --shadow: 0 18px 50px rgba(0,0,0,.55);

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color:var(--text);
      background:
        radial-gradient(900px 520px at 70% -10%, rgba(74,163,255,.10), transparent 60%),
        radial-gradient(800px 520px at 20% 0%, rgba(130,90,255,.08), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    .app{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      padding-top: var(--safeTop);
    }

    /* ===== TOP BAR ===== */
    .topbar{
      padding: 14px 16px 10px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background:var(--glass);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      cursor:pointer;
      user-select:none;
    }
    .titleWrap{flex:1; min-width:0}
    .title{
      font-weight:950;
      letter-spacing:.2px;
      font-size:18px;
      line-height:1.1;
      margin:0;
    }

    .wallet{
      display:flex; align-items:center; gap:10px;
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding: 9px 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .plus{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(43,123,255,.95));
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.22);
      cursor:pointer;
    }
    .balance{
      font-weight:950; font-size:14px;
      display:flex; align-items:center; gap:6px;
      min-width:80px; justify-content:flex-end;
    }
    .star{filter: drop-shadow(0 6px 16px rgba(255,213,106,.25))}
    .star::before{content:"‚òÖ"; color:var(--gold); font-size:16px}

    .content{
      flex:1;
      overflow:auto;
      padding: 8px 14px 110px;
      -webkit-overflow-scrolling: touch;
    }

    .sectionTitle{
      margin: 10px 4px 10px;
      text-transform:uppercase;
      letter-spacing:1.3px;
      font-weight:950;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      text-align:center;
    }

    .panel{
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius: 24px;
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .sep{height:10px}

    /* ===== BOTTOM NAV (–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ 1) ===== */
    .nav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(10,12,18,0), rgba(10,12,18,.55) 25%, rgba(10,12,18,.88));
      backdrop-filter: blur(16px);
      z-index:50;
    }

    .navBar{
      height: 72px;
      border-radius: 28px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 22px 70px rgba(0,0,0,.65);
      display:flex;
      overflow:hidden;
      position:relative;
      padding: 8px;
    }

    .navPill{
      position:absolute;
      top:8px; bottom:8px;
      left:8px;
      width:calc((100% - 16px) / 4);
      border-radius: 22px;
      background:
        radial-gradient(180px 70px at 50% 0%, rgba(255,255,255,.10), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(74,163,255,.16), rgba(74,163,255,.08));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      z-index:0;
      transform: translateX(0);
    }

    .tabBtn{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      color: rgba(255,255,255,.55);
      font-size: 11px;
      font-weight:950;
      letter-spacing:2px;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:1;
      text-transform:uppercase;
    }
    .tabBtn svg{width:22px;height:22px}
    .tabBtn.active{ color: rgba(255,255,255,.92); }

    /* Pages */
    .page{display:none}
    .page.active{display:block}

    /* ===== CASES GRID ===== */
    .casesGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .caseCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      cursor:pointer;
      position:relative;
      min-height: 220px;
      transform: translateZ(0);
    }
    .caseCard.big{ grid-column: span 2; min-height: 210px; }

    .badge{
      position:absolute;
      top:10px; left:10px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding: 6px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight:950;
      letter-spacing:.6px;
      z-index:3;
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:7px;
      color: rgba(255,255,255,.92);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(74,163,255,.95);
      box-shadow: 0 0 0 4px rgba(74,163,255,.10);
    }

    .caseHero{
      height: 148px;
      display:grid; place-items:center;
      position:relative;
      padding: 0; /* —á—Ç–æ–±—ã —Ñ–æ—Ç–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é */
      overflow:hidden;
    }
    .caseCard.big .caseHero{ height: 160px; }

    /* –£–ë–†–ê–õ–ò –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä-–æ–±–≤–æ–¥–∫—É –≤–æ–∫—Ä—É–≥ —Ñ–æ—Ç–æ –∫–µ–π—Å–æ–≤ */
    .caseAvatar{
      width: 100%;
      height: 100%;
      background: transparent;
      display:grid; place-items:center;
      overflow:hidden;
    }
    .caseAvatar img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform: scale(1.02);
    }
    .caseAvatar .fallback{
      font-size: 52px;
      color: rgba(255,255,255,.92);
      filter: drop-shadow(0 14px 30px rgba(0,0,0,.45));
    }

    .caseMeta{
      padding: 10px 14px 14px;
      position:relative;
      z-index:2;
    }
    .caseName{
      font-weight:950;
      font-size: 14px;
      margin: 0 0 8px;
      color: rgba(255,255,255,.92);
      min-height: 36px;
      line-height:1.15;
    }
    .priceRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:950;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .priceRow .left{
      display:flex; align-items:center; gap:8px;
    }
    .miniTag{
      font-size:11px;
      font-weight:950;
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.82);
    }

    /* ===== MODALS (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ) ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:120;
      padding: 12px 12px calc(12px + var(--safeBottom));
    }
    .overlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHead .h{
      font-weight:950;
      letter-spacing:1.1px;
      text-transform:uppercase;
      color: rgba(255,255,255,.84);
      font-size: 13px;
    }
    .xbtn{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }

    .btn{
      width:100%;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(43,123,255,.95));
      color:#fff;
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(43,123,255,.22);
    }
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
      color: rgba(255,255,255,.90);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    /* ===== CASE MODAL ===== */
    .casePreview{ padding: 12px 14px 0; text-align:center; }
    .bigImg{
      width: 100%;
      height: 190px;
      border-radius: 22px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      display:grid; place-items:center;
    }
    .bigImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .bigImg .fallback{font-size:76px; filter: drop-shadow(0 18px 45px rgba(0,0,0,.55));}
    .casePreview .name{ margin: 12px 0 0; font-weight:950; font-size: 18px; }
    .casePreview .desc{ margin: 6px 0 0; color: rgba(255,255,255,.65); font-size: 13px; line-height:1.35; }

    .chooser{ padding: 14px; display:flex; flex-direction:column; gap:12px; }
    .pillRow{
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      color: rgba(255,255,255,.85);
      font-weight:950;
      font-size:13px;
    }
    .countPills{ display:flex; gap:10px; justify-content:space-between; }
    .pill{
      flex:1;
      height: 44px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      color: rgba(255,255,255,.78);
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      background: linear-gradient(180deg, rgba(74,163,255,.22), rgba(74,163,255,.10));
      border:1px solid rgba(74,163,255,.22);
      color: rgba(255,255,255,.95);
      box-shadow: 0 14px 40px rgba(43,123,255,.16);
    }

    .rouletteWrap{
      margin: 0 14px 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
    }
    .rouletteTop{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.78);
      font-weight:950;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size: 12px;
    }
    .track{
      position:relative;
      height: 120px;
      overflow:hidden;
      background: rgba(0,0,0,.10);
    }
    .centerLine{
      position:absolute;
      top:10px; bottom:10px;
      left:50%;
      width: 3px;
      transform: translateX(-50%);
      background: rgba(74,163,255,.65);
      box-shadow: 0 0 0 6px rgba(74,163,255,.08);
      border-radius: 99px;
      z-index:5;
    }
    .reel{
      position:absolute;
      left:0; top:0;
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 14px;
      will-change: transform;
    }
    .itemChip{
      width: 104px;
      height: 92px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:7px;
      flex: 0 0 auto;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .chipImg{
      width:42px; height:42px;
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .chipImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .chipImg .fallback{font-size:24px}
    .itemChip .n{
      font-size: 11px;
      font-weight:950;
      color: rgba(255,255,255,.85);
      text-align:center;
      padding: 0 6px;
      line-height:1.05;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .resultToast{
      margin: 0 14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .resultToast.show{display:flex}
    .resultLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .resImg{
      width:44px;height:44px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .resImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .resImg .fallback{font-size:26px}
    .resultLeft .t{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .resultLeft .t b{font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .resultLeft .t span{font-size:12px; color:rgba(255,255,255,.65); display:flex; align-items:center; gap:6px}
    .tagWin{
      padding: 7px 10px;
      border-radius: 999px;
      font-weight:950;
      font-size: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      display:flex; align-items:center; gap:7px;
      white-space:nowrap;
    }
    .tagWin.good{border-color: rgba(37,227,154,.30); background: rgba(37,227,154,.10)}
    .tagWin.bad{border-color: rgba(255,74,106,.28); background: rgba(255,74,106,.10)}

    /* ===== INVENTORY ===== */
    .invGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    .giftCard{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 12px 35px rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 210px;
    }
    .giftTop{
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .giftQty{
      font-weight:950;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
      min-width: 56px;
      text-align:center;
      font-size: 12px;
    }
    /* –£–ë–†–ê–õ–ò –û–ë–í–û–î–ö–£ —É —Ñ–æ—Ç–æ –ø–æ–¥–∞—Ä–∫–æ–≤ */
    .giftImg{
      margin: 0 12px 10px;
      height: 96px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .giftImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .giftImg .fallback{font-size:44px}
    .giftMeta{
      padding: 0 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .giftName{
      font-weight:950;
      font-size: 12.5px;
      line-height:1.15;
      color: rgba(255,255,255,.92);
      min-height: 30px;
    }
    .giftPrice{
      display:flex; align-items:center; gap:8px;
      font-weight:950;
      color: rgba(255,255,255,.86);
      font-size: 12px;
    }
    .giftActions{
      margin-top:auto;
      padding: 12px;
      display:flex;
      gap:10px;
    }
    .btnSmall{
      flex:1;
      height: 40px;
      border-radius: 14px;
      font-weight:950;
      font-size: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .btnSmall.primary{
      background: rgba(74,163,255,.18);
      border-color: rgba(74,163,255,.22);
    }
    .btnSmall:active{transform: translateY(1px)}

    /* ===== UPGRADE (–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ 2: –º–∞–ª–µ–Ω—å–∫–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –ø–æ –∫–æ–ª—å—Ü—É + —Å–∏–Ω—è—è –ø–æ–ª–æ—Å–∞ WIN) ===== */
    .upgradeTitle{
      text-align:center;
      font-weight:950;
      letter-spacing:1.4px;
      text-transform:uppercase;
      color: rgba(255,255,255,.78);
      margin: 6px 0 14px;
      font-size: 13px;
    }
    .slots{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .slot{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 12px;
      min-height: 140px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .slot .label{
      font-size: 11px;
      font-weight:950;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .miniBtn{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.85);
      font-weight:950;
      font-size: 11px;
      cursor:pointer;
      user-select:none;
    }
    .pick{
      margin-top:auto;
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .pick .pImg{
      width:44px;height:44px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .pick .pImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .pick .pImg .fallback{font-size:24px}
    .pick .info{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .pick .info b{ font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pick .info span{ font-size: 12px; color: rgba(255,255,255,.65); display:flex; align-items:center; gap:6px; white-space:nowrap; }

    .upgradeMid{
      margin: 14px 0 0;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }

    /* –ö–æ–ª—å—Ü–æ */
    .ringWrap{
      width: 164px; height: 164px;
      position:relative;
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .ring{
      width: 164px; height: 164px;
      border-radius: 999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    /* —Å–µ—Ä–æ–µ –∫–æ–ª—å—Ü–æ */
    .ring::before{
      content:"";
      position:absolute; inset:12px;
      border-radius: 999px;
      border: 10px solid rgba(255,255,255,.08);
    }
    /* WIN-–ø–æ–ª–æ—Å–∞ (—Å–∏–Ω—è—è –¥—É–≥–∞), –¥–ª–∏–Ω–∞ = —à–∞–Ω—Å */
    .winArc{
      position:absolute;
      inset:12px;
      border-radius: 999px;
      border: 10px solid rgba(74,163,255,.65);
      /* –¥–ª–∏–Ω–∞ –∏ –ø–æ–≤–æ—Ä–æ—Ç –∑–∞–¥–∞—é—Ç—Å—è JS —á–µ—Ä–µ–∑ conic-gradient –º–∞—Å–∫—É */
      -webkit-mask: conic-gradient(#000 0deg, #000 10deg, transparent 10deg);
              mask: conic-gradient(#000 0deg, #000 10deg, transparent 10deg);
      filter: drop-shadow(0 10px 22px rgba(74,163,255,.18));
    }
    .centerBadge{
      width:74px; height:74px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      text-align:center;
      padding: 8px;
      z-index:3;
    }
    .centerBadge b{font-size: 16px}
    .centerBadge span{
      margin-top:2px;
      font-size: 10.5px;
      color: rgba(255,255,255,.62);
      font-weight:950;
      letter-spacing:1.2px;
      text-transform:uppercase
    }

    /* –ú–∞–ª–µ–Ω—å–∫–∞—è —Å—Ç—Ä–µ–ª–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ö–†–£–¢–ò–¢–°–Ø –ü–û –ö–û–õ–¨–¶–£ */
    .spinner{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      z-index:4;
      pointer-events:none;
    }
    .spinnerArm{
      width: 0;
      height: 0;
      position:absolute;
      top:50%; left:50%;
      transform-origin: 0 0;
      transform: rotate(0deg);
    }
    .needle{
      position:absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
      /* —Ç–æ—á–∫–∞ –Ω–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ */
      transform: translate(-50%, -50%);
    }
    .needleTip{
      position:absolute;
      width: 0; height:0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      border-bottom: 10px solid rgba(255,255,255,.95);
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
      transform: translate(-50%, -50%) rotate(0deg);
    }

    .upgradeControls{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .hint{
      font-size: 12.5px;
      color: rgba(255,255,255,.75);
      line-height:1.35;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 10px 10px;
    }

    /* Picker sheet */
    .sheetBody{
      max-height: 55vh;
      overflow:auto;
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .pickCard{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height: 120px;
    }
    .pickCard .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pickCard .pImg{
      width:40px;height:40px;border-radius: 14px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .pickCard .pImg img{width:100%; height:100%; object-fit:cover; display:block;}
    .pickCard .pImg .fallback{font-size:22px}
    .pickCard .nm{font-weight:950; font-size:12px; line-height:1.1; color:rgba(255,255,255,.92)}
    .pickCard .pr{font-weight:950; font-size:12px; color:rgba(255,255,255,.80); display:flex; align-items:center; gap:6px}
    .pickCard .sub{font-size:11px; color:rgba(255,255,255,.60)}
    .pickCard:active{transform: translateY(1px)}

    /* Contents modal list */
    .list{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .rowItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .rowLeft{display:flex; align-items:center; gap:10px; min-width:0;}
    .thumb{
      width:38px;height:38px;border-radius: 14px;
      background: rgba(0,0,0,.18);
      overflow:hidden; display:grid; place-items:center; flex:0 0 auto;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .rowLeft b{font-size:12.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rowLeft span{display:block; font-size:11px; color:rgba(255,255,255,.65);}
    .wBadge{
      font-weight:950;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }

    /* Add stars modal */
    .presetRow{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
      padding: 12px 14px 0;
    }
    .preset{
      height: 42px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      color: rgba(255,255,255,.86);
    }
    .preset.active{
      background: linear-gradient(180deg, rgba(74,163,255,.22), rgba(74,163,255,.10));
      border-color: rgba(74,163,255,.22);
      color: rgba(255,255,255,.95);
    }
    .inputWrap{ padding: 12px 14px 14px; display:flex; gap:10px; }
    .input{
      flex:1;
      height: 46px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      font-weight:950;
      padding: 0 12px;
      outline:none;
      font-size:14px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(92px + var(--safeBottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      display:none;
      z-index:200;
      font-weight:900;
      font-size: 13px;
      max-width: min(520px, calc(100% - 24px));
      text-align:center;
    }
    .toast.show{display:block}

    @media (min-width: 560px){
      .content{padding-left: 18px; padding-right:18px}
      .casesGrid{gap:14px}
      .invGrid{gap:14px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="back" id="btnBack" title="–ù–∞–∑–∞–¥">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M14.5 6L8.5 12l6 6" stroke="rgba(255,255,255,.9)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="titleWrap">
        <p class="title">Gifts Battle</p>
      </div>

      <div class="wallet">
        <div class="plus" id="btnAddStars" title="–ü–æ–ø–æ–ª–Ω–∏—Ç—å">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="balance"><span class="star"></span><span id="starsValue">0</span></div>
      </div>
    </div>

    <div class="content" id="scrollArea">
      <!-- HOME -->
      <div class="page active" id="pageHome">
        <div class="sectionTitle">CASES</div>
        <div class="casesGrid" id="casesGrid"></div>
      </div>

      <!-- UPGRADE -->
      <div class="page" id="pageUpgrade">
        <div class="sectionTitle">UPGRADE</div>

        <div class="panel">
          <div class="upgradeTitle">–ê–ø–≥—Ä–µ–π–¥</div>

          <div class="slots">
            <div class="slot" id="slotFrom">
              <div class="label">
                <span>–ß—Ç–æ –∞–ø–≥—Ä–µ–π–¥–∏–º</span>
                <span class="miniBtn" id="pickFromBtn">–í—ã–±—Ä–∞—Ç—å</span>
              </div>
              <div class="pick" id="fromPick"></div>
            </div>

            <div class="slot" id="slotTo">
              <div class="label">
                <span>–¶–µ–ª—å</span>
                <span class="miniBtn" id="pickToBtn">–í—ã–±—Ä–∞—Ç—å</span>
              </div>
              <div class="pick" id="toPick"></div>
            </div>
          </div>

          <div class="upgradeMid">
            <div class="ringWrap" aria-label="–®–∞–Ω—Å + —Å—Ç—Ä–µ–ª–∫–∞ –ø–æ –∫–æ–ª—å—Ü—É">
              <div class="ring" id="ring">
                <div class="winArc" id="winArc"></div>

                <div class="spinner">
                  <div class="spinnerArm" id="spinnerArm">
                    <div class="needle" id="needleDot"></div>
                    <div class="needleTip" id="needleTip"></div>
                  </div>
                </div>

                <div class="centerBadge">
                  <b id="chanceText">0%</b>
                  <span>chance</span>
                </div>
              </div>
            </div>

            <div class="upgradeControls">
              <div class="hint" id="upgradeHint">
                –í—ã–±–µ—Ä–∏ <b>–∏—Å—Ö–æ–¥–Ω—ã–π</b> –ø–æ–¥–∞—Ä–æ–∫ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏ <b>—Ü–µ–ª—å</b>.
              </div>
              <button class="btn" id="btnUpgrade" disabled>–ê–ø–≥—Ä–µ–π–¥</button>
              <button class="btn ghost" id="btnResetUpgrade">–°–±—Ä–æ—Å–∏—Ç—å</button>
              <div class="hint" id="upgradeResultNote" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="page" id="pageInv">
        <div class="sectionTitle">INVENTORY</div>

        <div class="panel">
          <div class="invGrid" id="invGrid"></div>

          <div class="sep"></div>
          <button class="btn ghost" id="btnSellAll">–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ</button>
        </div>
      </div>

      <!-- TOP (placeholder, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ) -->
      <div class="page" id="pageTop">
        <div class="sectionTitle">TOP</div>
        <div class="panel">
          <div class="hint" style="text-align:center">
            –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥ (—Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤ / –≤—ã–∏–≥—Ä—ã—à–µ–π).
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <div class="nav">
      <div class="navBar" id="navBar">
        <div class="navPill" id="navPill"></div>

        <div class="tabBtn active" data-tab="home" data-index="0">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 11.2 12 4l8 7.2V20a1.8 1.8 0 0 1-1.8 1.8H5.8A1.8 1.8 0 0 1 4 20v-8.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9.5 21v-7.2h5V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          COIN
        </div>

        <div class="tabBtn" data-tab="upgrade" data-index="1">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 2.8l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4-5.8-3.1-5.8 3.1 1.1-6.4-4.7-4.6 6.5-.9L12 2.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          TASKS
        </div>

        <div class="tabBtn" data-tab="top" data-index="2">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 20V11M12 20V4M17 20v-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
          TOP
        </div>

        <div class="tabBtn" data-tab="inv" data-index="3">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 7.5h12l-1 13.2a1.7 1.7 0 0 1-1.7 1.6H8.7A1.7 1.7 0 0 1 7 20.7L6 7.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M9 7.5V6a3 3 0 0 1 6 0v1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          BOOST
        </div>
      </div>
    </div>
  </div>

  <!-- Case Modal -->
  <div class="overlay" id="caseModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="h" id="modalHeader">CASE</div>
        <div class="xbtn" id="closeCaseModal">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="casePreview">
        <div class="bigImg" id="modalBigImg"></div>
        <div class="name" id="modalName">CASE</div>
        <div class="desc" id="modalDesc">–û—Ç–∫—Ä–æ–π –∫–µ–π—Å ‚Äî –ø–æ–ª—É—á–∏ –ø–æ–¥–∞—Ä–æ–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
      </div>

      <div class="chooser">
        <div class="pillRow">
          <div>How many cases?</div>
          <div style="display:flex; align-items:center; gap:6px; color:rgba(255,255,255,.8)">
            <span class="star"></span><span id="modalPrice">0</span>
          </div>
        </div>

        <div class="countPills" id="countPills">
          <div class="pill active" data-n="1">1</div>
          <div class="pill" data-n="2">2</div>
          <div class="pill" data-n="3">3</div>
          <div class="pill" data-n="4">4</div>
          <div class="pill" data-n="5">5</div>
        </div>
      </div>

      <div class="rouletteWrap">
        <div class="rouletteTop">
          <span>roulette</span>
          <span style="color:rgba(255,255,255,.65)" id="rouletteHint">–ù–∞–∂–º–∏ ‚ÄúOpen case‚Äù</span>
        </div>
        <div class="track">
          <div class="centerLine"></div>
          <div class="reel" id="reel"></div>
        </div>
      </div>

      <div class="resultToast" id="resultToast">
        <div class="resultLeft">
          <div class="resImg" id="resImg"></div>
          <div class="t">
            <b id="resName">Gift</b>
            <span><span class="star"></span><span id="resValue">0</span> ‚Ä¢ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
          </div>
        </div>
        <div class="tagWin good" id="resTag"><span>‚úî</span><span>WIN</span></div>
      </div>

      <div style="padding: 0 14px 14px;">
        <button class="btn" id="btnOpenCase"><span>Open case</span> <span class="star"></span><span id="btnCost">0</span></button>
        <div class="sep"></div>
        <button class="btn ghost" id="btnShowContents">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ</button>
      </div>
    </div>
  </div>

  <!-- Contents Modal -->
  <div class="overlay" id="contentsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="h" id="contentsTitle">CONTENTS</div>
        <div class="xbtn" id="closeContents">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
      <div class="list" id="contentsList"></div>
      <div style="padding:0 14px 14px;">
        <button class="btn ghost" id="closeContentsBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Add Stars Modal -->
  <div class="overlay" id="addStarsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="h">ADD STARS</div>
        <div class="xbtn" id="closeAddStars">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="presetRow" id="presetRow">
        <div class="preset" data-v="10">10</div>
        <div class="preset" data-v="50">50</div>
        <div class="preset active" data-v="100">100</div>
        <div class="preset" data-v="500">500</div>
        <div class="preset" data-v="5000">5000</div>
      </div>

      <div class="inputWrap">
        <input class="input" id="starsInput" inputmode="numeric" placeholder="–°—É–º–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 100)" value="100" />
        <button class="btn" id="btnApplyStars" style="width: 150px;">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div style="padding:0 14px 14px;">
        <button class="btn ghost" id="btnCancelStars">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- Picker Sheet -->
  <div class="overlay" id="pickerOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="h" id="pickerTitle">–í—ã–±–µ—Ä–∏ –ø–æ–¥–∞—Ä–æ–∫</div>
        <div class="xbtn" id="pickerClose">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.9)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
      <div class="sheetBody" id="pickerBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

  <script>
    /********************
     * Telegram init
     ********************/
    const tg = window.Telegram?.WebApp;
    try{ tg?.ready(); tg?.expand(); }catch(e){}

    /********************
     * Economy / Edge tuning
     ********************/
    const CASE_EDGE_LOW_BOOST = 1.22;  // –∫–µ–π—Å—ã: —á–∞—â–µ –¥–µ—à—ë–≤—ã–µ
    const UPGRADE_EDGE = 0.88;         // –∞–ø–≥—Ä–µ–π–¥: —à–∞–Ω—Å –Ω–∏–∂–µ –±–∞–∑–æ–≤–æ–≥–æ
    const SELL_PAYOUT = 0.80;          // –ø—Ä–æ–¥–∞–∂–∞: 80%

    /********************
     * Storage
     ********************/
    const STORAGE = {
      stars: "gb3_stars",
      inv: "gb3_inventory"
    };

    /********************
     * Assets (–∑–∞–º–µ–Ω–∏ –ø—É—Ç–∏ –Ω–∞ —Å–≤–æ–∏)
     ********************/
    const GIFTS = [
      { id:"pin",   name:"Telegram Pin",        emoji:"üìé", value:3000, img:"IMG_5264.PNG" },
      { id:"lock",  name:"Heart Locket",       emoji:"üíô", value:1799, img:"img/gifts/lock.png" },
      { id:"watch", name:"Golden Watch",       emoji:"‚åö", value:980,  img:"img/gifts/watch.png" },
      { id:"cap",   name:"Durov‚Äôs Cap",        emoji:"üß¢", value:775,  img:"img/gifts/cap.png" },
      { id:"gem",   name:"Blue Gem",           emoji:"üíé", value:462,  img:"img/gifts/gem.png" },
      { id:"peach", name:"Precious Peach",     emoji:"üçë", value:480,  img:"img/gifts/peach.png" },
      { id:"ring",  name:"Shiny Ring",         emoji:"üíç", value:260,  img:"img/gifts/ring.png" },
      { id:"jack",  name:"Jack-in-the-Box",    emoji:"üéÅ", value:231,  img:"img/gifts/jack.png" },
      { id:"candle",name:"B-Day Candle",       emoji:"üéÇ", value:149,  img:"img/gifts/candle.png" },
      { id:"muscle",name:"Power Arm",          emoji:"üí™", value:120,  img:"img/gifts/muscle.png" },
      { id:"bear",  name:"Soft Toy",           emoji:"üß∏", value:90,   img:"img/gifts/bear.png" },
      { id:"plane", name:"Paper Plane Charm",  emoji:"‚úàÔ∏è", value:85,   img:"img/gifts/plane.png" },
      { id:"duck",  name:"Little Duck",        emoji:"ü¶Ü", value:55,   img:"img/gifts/duck.png" },
      { id:"cookie",name:"Lucky Cookie",       emoji:"üç™", value:35,   img:"img/gifts/cookie.png" }
    ];

    const CASES = [
      { id:"durov_mining", title:"Durov Mining", price:272, badge:"LIMITED", emoji:"‚õèÔ∏è", img:"IMG_5264.PNG",
        desc:"–õ–∏–º–∏—Ç–Ω—ã–π –∫–µ–π—Å.",
        pool:[ {gift:"cookie",w:28},{gift:"duck",w:22},{gift:"plane",w:14},{gift:"bear",w:11},{gift:"muscle",w:9},{gift:"ring",w:6},{gift:"gem",w:4},{gift:"cap",w:3},{gift:"watch",w:2},{gift:"pin",w:1} ]
      },
      { id:"champion", title:"Champion", price:452, badge:"LIMITED", emoji:"ü•ä", img:"img/cases/champion.png",
        desc:"–•–æ—Ä–æ—à–∏–π –∫–µ–π—Å.",
        pool:[ {gift:"cookie",w:18},{gift:"duck",w:18},{gift:"plane",w:12},{gift:"bear",w:10},{gift:"candle",w:10},{gift:"jack",w:9},{gift:"ring",w:7},{gift:"gem",w:6},{gift:"cap",w:4},{gift:"watch",w:3},{gift:"lock",w:2},{gift:"pin",w:1} ]
      },
      { id:"cemetery", title:"The Cemetery of Secrets", price:1104, badge:"LIMITED", emoji:"üïØÔ∏è", img:"img/cases/cemetery.png", big:true,
        desc:"–î–æ—Ä–æ–≥–æ–π –∫–µ–π—Å.",
        pool:[ {gift:"duck",w:10},{gift:"candle",w:12},{gift:"jack",w:10},{gift:"ring",w:10},{gift:"gem",w:10},{gift:"cap",w:9},{gift:"watch",w:8},{gift:"lock",w:7},{gift:"pin",w:4} ]
      },
      { id:"pepe_all_in", title:"PEPE ALL IN", price:55, badge:"HOT", emoji:"üê∏", img:"img/cases/pepe.png",
        desc:"–ë—ã—Å—Ç—Ä—ã–π –∫–µ–π—Å.",
        pool:[ {gift:"cookie",w:40},{gift:"duck",w:26},{gift:"plane",w:16},{gift:"bear",w:10},{gift:"muscle",w:6},{gift:"ring",w:2} ]
      },
      { id:"blue_drop", title:"Blue Drop", price:120, badge:"NEW", emoji:"üíß", img:"img/cases/blue_drop.png",
        desc:"–ù–µ–ø–ª–æ—Ö–æ–π —Ñ–∞—Ä–º.",
        pool:[ {gift:"cookie",w:34},{gift:"duck",w:24},{gift:"plane",w:16},{gift:"bear",w:12},{gift:"candle",w:8},{gift:"jack",w:4},{gift:"ring",w:2} ]
      },
      { id:"durov_classic", title:"Durov Classic", price:360, badge:"LIMITED", emoji:"üß¢", img:"img/cases/durov_classic.png",
        desc:"–ö–ª–∞—Å—Å–∏–∫–∞.",
        pool:[ {gift:"duck",w:20},{gift:"bear",w:14},{gift:"candle",w:12},{gift:"jack",w:10},{gift:"ring",w:10},{gift:"gem",w:8},{gift:"cap",w:6},{gift:"watch",w:3},{gift:"lock",w:2},{gift:"pin",w:1} ]
      },
      { id:"gold_rush", title:"Gold Rush", price:680, badge:"HOT", emoji:"‚ú®", img:"img/cases/gold_rush.png",
        desc:"–°—Ç–∞–≤–∫–∞ –≤—ã—à–µ.",
        pool:[ {gift:"candle",w:16},{gift:"jack",w:14},{gift:"ring",w:12},{gift:"gem",w:12},{gift:"cap",w:10},{gift:"watch",w:8},{gift:"lock",w:6},{gift:"pin",w:3} ]
      },
      { id:"telegram_hearts", title:"Telegram Hearts", price:240, badge:"NEW", emoji:"üíô", img:"img/cases/hearts.png",
        desc:"–£–∫–ª–æ–Ω –≤ locket.",
        pool:[ {gift:"cookie",w:20},{gift:"duck",w:20},{gift:"bear",w:14},{gift:"candle",w:12},{gift:"ring",w:10},{gift:"gem",w:8},{gift:"lock",w:6},{gift:"watch",w:3},{gift:"pin",w:1} ]
      },
      { id:"skyline", title:"Skyline", price:190, badge:"NEW", emoji:"üåå", img:"img/cases/skyline.png",
        desc:"–õ—ë–≥–∫–∏–π –∫–µ–π—Å.",
        pool:[ {gift:"cookie",w:30},{gift:"duck",w:22},{gift:"plane",w:18},{gift:"bear",w:12},{gift:"muscle",w:10},{gift:"candle",w:6},{gift:"ring",w:2} ]
      }
    ];

    /********************
     * State
     ********************/
    let stars = loadNumber(STORAGE.stars, 74.2);
    let inventory = loadJSON(STORAGE.inv, {}); // {giftId: qty}

    let currentCase = CASES[0];
    let openCount = 1;

    let upgradeFrom = null;
    let upgradeTo = null;

    // –¥–ª—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ (—É–≥–æ–ª)
    let spinnerAngle = 0;

    /********************
     * DOM
     ********************/
    const starsValue = document.getElementById("starsValue");
    const casesGrid  = document.getElementById("casesGrid");
    const invGrid = document.getElementById("invGrid");

    const pages = {
      home: document.getElementById("pageHome"),
      upgrade: document.getElementById("pageUpgrade"),
      top: document.getElementById("pageTop"),
      inv: document.getElementById("pageInv")
    };

    const navPill = document.getElementById("navPill");

    // Case modal
    const caseModal = document.getElementById("caseModal");
    const closeCaseModal = document.getElementById("closeCaseModal");
    const modalHeader = document.getElementById("modalHeader");
    const modalBigImg = document.getElementById("modalBigImg");
    const modalName = document.getElementById("modalName");
    const modalDesc = document.getElementById("modalDesc");
    const modalPrice = document.getElementById("modalPrice");
    const btnCost = document.getElementById("btnCost");
    const btnOpenCase = document.getElementById("btnOpenCase");
    const btnShowContents = document.getElementById("btnShowContents");
    const countPills = document.getElementById("countPills");
    const reel = document.getElementById("reel");
    const rouletteHint = document.getElementById("rouletteHint");
    const resultToast = document.getElementById("resultToast");
    const resImg = document.getElementById("resImg");
    const resName = document.getElementById("resName");
    const resValue = document.getElementById("resValue");
    const resTag = document.getElementById("resTag");

    // Contents modal
    const contentsModal = document.getElementById("contentsModal");
    const contentsTitle = document.getElementById("contentsTitle");
    const contentsList = document.getElementById("contentsList");
    const closeContents = document.getElementById("closeContents");
    const closeContentsBtn = document.getElementById("closeContentsBtn");

    // Add stars modal
    const addStarsModal = document.getElementById("addStarsModal");
    const closeAddStars = document.getElementById("closeAddStars");
    const btnCancelStars = document.getElementById("btnCancelStars");
    const presetRow = document.getElementById("presetRow");
    const starsInput = document.getElementById("starsInput");
    const btnApplyStars = document.getElementById("btnApplyStars");

    // Upgrade
    const pickFromBtn = document.getElementById("pickFromBtn");
    const pickToBtn = document.getElementById("pickToBtn");
    const fromPick = document.getElementById("fromPick");
    const toPick = document.getElementById("toPick");
    const btnUpgrade = document.getElementById("btnUpgrade");
    const btnResetUpgrade = document.getElementById("btnResetUpgrade");
    const upgradeHint = document.getElementById("upgradeHint");
    const upgradeResultNote = document.getElementById("upgradeResultNote");
    const chanceText = document.getElementById("chanceText");
    const winArc = document.getElementById("winArc");
    const spinnerArm = document.getElementById("spinnerArm");
    const needleDot = document.getElementById("needleDot");
    const needleTip = document.getElementById("needleTip");

    // Picker
    const pickerOverlay = document.getElementById("pickerOverlay");
    const pickerTitle = document.getElementById("pickerTitle");
    const pickerBody = document.getElementById("pickerBody");
    const pickerClose = document.getElementById("pickerClose");
    let pickerMode = "from";

    // Sell all
    const btnSellAll = document.getElementById("btnSellAll");

    // Toast
    const toast = document.getElementById("toast");

    /********************
     * Init
     ********************/
    renderStars();
    renderCases();
    renderInventory();
    renderUpgrade();
    buildReel(currentCase);

    gsap.fromTo(".topbar", {y:-10, opacity:0}, {y:0, opacity:1, duration:.45, ease:"power2.out"});
    gsap.fromTo(".navBar", {y:12, opacity:0}, {y:0, opacity:1, duration:.5, ease:"power2.out", delay:.05});
    updateNavPill(0, false);

    // place needle on ring radius
    positionNeedle();

    function positionNeedle(){
      // —Ä–∞–¥–∏—É—Å: –ø–æ–ª–æ–≤–∏–Ω–∞ –∫–æ–ª—å—Ü–∞ - –æ—Ç—Å—Ç—É–ø—ã
      const R = 82; // –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–ª–æ–≤–∏–Ω–∞ 164
      const ringInset = 12 + 10; // inset + border
      const radius = R - ringInset + 2; // –ø–æ —Ü–µ–Ω—Ç—Ä—É –ª–∏–Ω–∏–∏

      // —Å—Ç–∞–≤–∏–º –∏–≥–æ–ª–∫—É/—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –≤ —Ç–æ—á–∫—É –Ω–∞ —Ä–∞–¥–∏—É—Å–µ (–≤–≤–µ—Ä—Ö)
      // spinnerArm –≤—Ä–∞—â–∞–µ—Ç—Å—è –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–º–µ—Å—Ç–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ "—Å–µ–≤–µ—Ä"
      needleDot.style.left = "0px";
      needleDot.style.top = `-${radius}px`;

      needleTip.style.left = "0px";
      needleTip.style.top = `-${radius - 14}px`;
    }

    /********************
     * Top actions
     ********************/
    document.getElementById("btnBack").addEventListener("click", ()=>{
      try{
        if(tg?.BackButton){ tg.close(); }
        else tg?.close?.();
      }catch(e){
        // –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        showToast("–ù–∞–∑–∞–¥");
      }
    });

    document.getElementById("btnAddStars").addEventListener("click", ()=>{
      openAddStarsModal();
    });

    /********************
     * Tabs + pill slide
     ********************/
    document.querySelectorAll(".tabBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tab = btn.dataset.tab;
        const idx = Number(btn.dataset.index || "0");
        setTab(tab, idx);
      });
    });

    function setTab(tab, idx){
      document.querySelectorAll(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      Object.values(pages).forEach(p=>p.classList.remove("active"));

      const pageEl = pages[tab] || pages.home;
      pageEl.classList.add("active");

      updateNavPill(idx, true);

      gsap.fromTo(pageEl, {opacity:0, y:10}, {opacity:1, y:0, duration:.22, ease:"power2.out"});
      document.getElementById("scrollArea").scrollTop = 0;

      renderInventory();
      renderUpgrade();
    }

    function updateNavPill(index, animate=true){
      const bar = document.getElementById("navBar");
      const w = bar.clientWidth;
      const pillW = (w - 16) / 4;
      const x = 8 + index * pillW;
      if(!animate){
        gsap.set(navPill, {x: x - 8});
        return;
      }
      gsap.to(navPill, {x: x - 8, duration:.28, ease:"power2.out"});
    }

    window.addEventListener("resize", ()=>{
      const active = document.querySelector(".tabBtn.active");
      const idx = Number(active?.dataset.index || "0");
      updateNavPill(idx, false);
      positionNeedle();
    });

    /********************
     * Cases grid
     ********************/
    function renderCases(){
      casesGrid.innerHTML = "";

      const ordered = [];
      const big = CASES.find(c=>c.big);
      const notBig = CASES.filter(c=>!c.big);
      ordered.push(notBig[0], notBig[1]);
      if(big) ordered.push(big);
      notBig.slice(2).forEach(c=>ordered.push(c));

      ordered.forEach(c=>{
        const el = document.createElement("div");
        el.className = "caseCard" + (c.big ? " big" : "");
        el.innerHTML = `
          <div class="badge"><span class="dot"></span>${escapeHtml(c.badge)}</div>
          <div class="caseHero">
            <div class="caseAvatar">
              ${c.img ? `<img src="${escapeAttr(c.img)}" alt="">` : `<div class="fallback">${escapeHtml(c.emoji || "üéÅ")}</div>`}
            </div>
          </div>
          <div class="caseMeta">
            <div class="caseName">${escapeHtml(c.title)}</div>
            <div class="priceRow">
              <div class="left"><span class="star"></span><span>${formatStars(c.price)}</span></div>
              <div class="miniTag">Open</div>
            </div>
          </div>
        `;
        el.addEventListener("click", ()=> openCaseModal(c));
        casesGrid.appendChild(el);

        el.addEventListener("pointerdown", ()=> gsap.to(el, {scale:0.985, duration:.12, ease:"power2.out"}));
        el.addEventListener("pointerup", ()=> gsap.to(el, {scale:1, duration:.18, ease:"power2.out"}));
        el.addEventListener("pointerleave", ()=> gsap.to(el, {scale:1, duration:.18, ease:"power2.out"}));
      });
    }

    /********************
     * Case Modal + roulette
     ********************/
    closeCaseModal.addEventListener("click", ()=>hideOverlay(caseModal));
    caseModal.addEventListener("click", (e)=>{ if(e.target === caseModal) hideOverlay(caseModal); });

    countPills.addEventListener("click", (e)=>{
      const pill = e.target.closest(".pill");
      if(!pill) return;
      openCount = Number(pill.dataset.n || "1");
      [...countPills.querySelectorAll(".pill")].forEach(p=>p.classList.toggle("active", p===pill));
      updateModalPrice();
      pulse("#countPills");
    });

    btnShowContents.addEventListener("click", ()=>{
      openContentsModal(currentCase);
    });

    btnOpenCase.addEventListener("click", async ()=>{
      const totalCost = currentCase.price * openCount;
      if(stars + 1e-9 < totalCost){
        showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚òÖ");
        wiggle(".wallet");
        return;
      }

      stars = round1(stars - totalCost);
      saveNumber(STORAGE.stars, stars);
      renderStars();

      btnOpenCase.disabled = true;
      rouletteHint.textContent = "–ö—Ä—É—Ç–∏–º‚Ä¶";
      resultToast.classList.remove("show");

      for(let i=0;i<openCount;i++){
        const wonGiftId = weightedPickWithEdge(currentCase.pool);
        const won = getGift(wonGiftId);

        await spinTo(wonGiftId, currentCase);

        addToInv(wonGiftId, 1);
        renderInventory();

        resImg.innerHTML = giftThumbHTML(won, 44);
        resName.textContent = won.name;
        resValue.textContent = formatStars(won.value);
        resTag.className = "tagWin good";
        resTag.innerHTML = `<span>‚úî</span><span>WIN</span>`;
        resultToast.classList.add("show");
        gsap.fromTo(resultToast, {y:10, opacity:0}, {y:0, opacity:1, duration:.20, ease:"power2.out"});

        if(i < openCount-1){
          await sleep(450);
          resultToast.classList.remove("show");
          rouletteHint.textContent = `–ï—â—ë ${openCount-1-i}‚Ä¶`;
          await sleep(220);
        }
      }

      rouletteHint.textContent = "–ì–æ—Ç–æ–≤–æ";
      btnOpenCase.disabled = false;
      pulse(".resultToast");
    });

    function openCaseModal(c){
      currentCase = c;
      openCount = 1;
      [...countPills.querySelectorAll(".pill")].forEach((p,idx)=>p.classList.toggle("active", idx===0));

      modalHeader.textContent = c.title.toUpperCase();
      modalName.textContent = c.title;
      modalDesc.textContent = c.desc;

      modalBigImg.innerHTML = c.img
        ? `<img src="${escapeAttr(c.img)}" alt="">`
        : `<div class="fallback">${escapeHtml(c.emoji || "üéÅ")}</div>`;

      buildReel(c);
      updateModalPrice();
      rouletteHint.textContent = "–ù–∞–∂–º–∏ ‚ÄúOpen case‚Äù";
      resultToast.classList.remove("show");

      showOverlay(caseModal);
      gsap.fromTo(caseModal.querySelector(".modal"), {y:20, opacity:0}, {y:0, opacity:1, duration:.22, ease:"power2.out"});
      pulse(caseModal.querySelector(".modal"));
    }

    function updateModalPrice(){
      const total = currentCase.price * openCount;
      modalPrice.textContent = formatStars(total);
      btnCost.textContent = formatStars(total);
    }

    function buildReel(caseObj){
      reel.innerHTML = "";
      const base = [];
      caseObj.pool.forEach(p=>{
        const g = getGift(p.gift);
        for(let k=0;k<Math.max(1, Math.round(p.w/8));k++) base.push(g);
      });

      const strip = [];
      for(let i=0;i<64;i++){
        strip.push(base[randInt(0, base.length-1)]);
      }

      strip.forEach(g=>{
        const chip = document.createElement("div");
        chip.className = "itemChip";
        chip.dataset.gift = g.id;
        chip.innerHTML = `
          <div class="chipImg">${giftThumbHTML(g, 42)}</div>
          <div class="n">${escapeHtml(g.name)}</div>
        `;
        reel.appendChild(chip);
      });

      gsap.set(reel, {x:0});
    }

    async function spinTo(giftId, caseObj){
      buildReel(caseObj);

      const chips = [...reel.querySelectorAll(".itemChip")];
      const targetIndex = randInt(40, 56);

      const g = getGift(giftId);
      chips[targetIndex].dataset.gift = giftId;
      chips[targetIndex].innerHTML = `
        <div class="chipImg">${giftThumbHTML(g, 42)}</div>
        <div class="n">${escapeHtml(g.name)}</div>
      `;

      const chipW = 114;
      const containerW = document.querySelector(".track").clientWidth;
      const centerX = containerW / 2;
      const leftPadding = 14;
      const targetX = leftPadding + targetIndex * chipW + 52;
      const finalX = centerX - targetX;

      const dur = 2.0 + Math.random()*0.6;
      const overshoot = finalX - (45 + Math.random()*45);

      gsap.set(reel, {x: 20});
      await sleep(50);

      await gsapToPromise(reel, { x: overshoot, duration: dur, ease: "power3.out" });
      await gsapToPromise(reel, { x: finalX, duration: 0.5, ease: "elastic.out(1, 0.35)" });

      const winChip = chips[targetIndex];
      gsap.fromTo(winChip, {scale:1}, {scale:1.07, duration:.16, yoyo:true, repeat:1, ease:"power2.out"});
      pulse(".centerLine");
    }

    /********************
     * Inventory
     ********************/
    function renderInventory(){
      saveJSON(STORAGE.inv, inventory);

      const entries = Object.entries(inventory)
        .filter(([_,qty])=>qty>0)
        .map(([id,qty])=>({ ...getGift(id), qty }))
        .sort((a,b)=> b.value - a.value);

      if(entries.length===0){
        invGrid.innerHTML = `<div class="hint" style="grid-column: span 2; text-align:center;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>`;
      } else {
        invGrid.innerHTML = "";
        entries.forEach(it=>{
          const el = document.createElement("div");
          el.className = "giftCard";
          el.innerHTML = `
            <div class="giftTop">
              <div class="giftQty">x${it.qty}</div>
              <div class="giftPrice"><span class="star"></span>${formatStars(it.value)}</div>
            </div>

            <div class="giftImg">
              ${it.img ? `<img src="${escapeAttr(it.img)}" alt="">` : `<div class="fallback">${escapeHtml(it.emoji || "üéÅ")}</div>`}
            </div>

            <div class="giftMeta">
              <div class="giftName">${escapeHtml(it.name)}</div>
            </div>

            <div class="giftActions">
              <button class="btnSmall" data-act="sell" data-id="${escapeAttr(it.id)}">–ü—Ä–æ–¥–∞—Ç—å</button>
              <button class="btnSmall primary" data-act="withdraw" data-id="${escapeAttr(it.id)}">–í—ã–≤–µ—Å—Ç–∏</button>
            </div>
          `;
          invGrid.appendChild(el);
        });
      }

      invGrid.querySelectorAll("button.btnSmall").forEach(b=>{
        b.addEventListener("click", ()=>{
          const act = b.dataset.act;
          const id = b.dataset.id;
          if(!id) return;
          if(act === "sell") sellGift(id);
          if(act === "withdraw") withdrawGift(id);
        });
      });
    }

    function sellGift(giftId){
      const qty = inventory[giftId] || 0;
      if(qty <= 0) return;

      const g = getGift(giftId);
      removeFromInv(giftId, 1);

      const payout = round1(g.value * SELL_PAYOUT);
      stars = round1(stars + payout);

      saveNumber(STORAGE.stars, stars);
      renderStars();
      renderInventory();
      renderUpgrade();

      showToast(`+${formatStars(payout)}‚òÖ`);
      pulse(".wallet");
    }

    function withdrawGift(giftId){
      const qty = inventory[giftId] || 0;
      if(qty <= 0) return;

      const g = getGift(giftId);
      showToast(`–í—ã–≤–µ—Å—Ç–∏: ${g.name}`);
      pulse(".giftCard");
    }

    btnSellAll.addEventListener("click", ()=>{
      const entries = Object.entries(inventory).filter(([_,q])=>q>0);
      if(entries.length===0){
        showToast("–ù–µ—á–µ–≥–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å");
        return;
      }

      let total = 0;
      for(const [id, qty] of entries){
        const g = getGift(id);
        total += g.value * qty * SELL_PAYOUT;
      }
      total = round1(total);

      inventory = {};
      saveJSON(STORAGE.inv, inventory);

      stars = round1(stars + total);
      saveNumber(STORAGE.stars, stars);

      upgradeFrom = null;
      upgradeTo = null;

      renderStars();
      renderInventory();
      renderUpgrade();

      showToast(`–ü—Ä–æ–¥–∞–Ω–æ –≤—Å—ë: +${formatStars(total)}‚òÖ`);
      pulse(".wallet");
    });

    function addToInv(giftId, qty){
      inventory[giftId] = (inventory[giftId]||0) + qty;
      saveJSON(STORAGE.inv, inventory);
    }
    function removeFromInv(giftId, qty){
      const cur = inventory[giftId] || 0;
      const next = Math.max(0, cur - qty);
      inventory[giftId] = next;
      saveJSON(STORAGE.inv, inventory);
    }

    /********************
     * Upgrade (–∫–æ–ª—å—Ü–æ + —Å–∏–Ω—è—è –ø–æ–ª–æ—Å–∞ WIN)
     ********************/
    pickFromBtn.addEventListener("click", ()=>{
      pickerMode = "from";
      openPickerFromInventory();
    });
    pickToBtn.addEventListener("click", ()=>{
      pickerMode = "to";
      openPickerFromCatalog();
    });

    btnResetUpgrade.addEventListener("click", ()=>{
      upgradeFrom = null;
      upgradeTo = null;
      upgradeResultNote.style.display = "none";
      renderUpgrade();
      showToast("–°–±—Ä–æ—à–µ–Ω–æ");
    });

    btnUpgrade.addEventListener("click", async ()=>{
      const chance = calcChance();
      if(!upgradeFrom || !upgradeTo || chance<=0){
        wiggle("#upgradeHint");
        showToast("–í—ã–±–µ—Ä–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∏ —Ü–µ–ª—å");
        return;
      }
      if((inventory[upgradeFrom]||0) <= 0){
        showToast("–ù–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞");
        renderUpgrade();
        return;
      }

      btnUpgrade.disabled = true;
      upgradeResultNote.style.display = "none";

      // WIN –∑–æ–Ω–∞: 0..winDeg (—Å–≤–µ—Ä—Ö—É, –ø–æ —á–∞—Å–æ–≤–æ–π)
      const winDeg = clamp(chance, 1.2, 95) * 3.6;

      // —Ä–µ—à–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      const roll = Math.random()*100;
      const success = roll < chance;

      // —Ü–µ–ª–µ–≤–æ–π —É–≥–æ–ª: –µ—Å–ª–∏ win -> –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å–∏–Ω—é—é –¥—É–≥—É, –∏–Ω–∞—á–µ -> –∑–∞ –µ—ë –ø—Ä–µ–¥–µ–ª—ã
      const targetAngle = success
        ? randFloat(6, Math.max(8, winDeg - 6))
        : randFloat(Math.min(360 - 6, winDeg + 6), 360 - 6);

      // –ø–ª–∞–≤–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä—É–≥–æ–≤
      const spins = 4 + randInt(0,2);
      const final = (spinnerAngle % 360) + spins*360 + targetAngle;
      spinnerAngle = final;

      await gsapToPromise(spinnerArm, { rotation: final, duration: 1.35, ease:"power3.out" });

      // —Ä–∞—Å—Ö–æ–¥: 1 –∏—Å—Ö–æ–¥–Ω—ã–π –≤—Å–µ–≥–¥–∞
      removeFromInv(upgradeFrom, 1);

      if(success){
        addToInv(upgradeTo, 1);
        upgradeResultNote.style.display = "block";
        upgradeResultNote.innerHTML = `‚úÖ –£—Å–ø–µ—Ö! <b>${escapeHtml(getGift(upgradeTo).name)}</b> –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.`;
        pulse("#slotTo");
        showToast("WIN");
      }else{
        upgradeResultNote.style.display = "block";
        upgradeResultNote.innerHTML = `‚ùå –ù–µ—É–¥–∞—á–∞. –ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ —Å–≥–æ—Ä–µ–ª.`;
        wiggle("#slotFrom");
        showToast("LOSE");
      }

      renderInventory();

      if(upgradeFrom && (inventory[upgradeFrom]||0) <= 0) upgradeFrom = null;

      btnUpgrade.disabled = false;
      renderUpgrade();
    });

    function renderUpgrade(){
      if(upgradeFrom){
        const g = getGift(upgradeFrom);
        const qty = inventory[upgradeFrom] || 0;
        fromPick.innerHTML = `
          <div class="pImg">${giftThumbHTML(g, 44)}</div>
          <div class="info">
            <b>${escapeHtml(g.name)}</b>
            <span><span class="star"></span>${formatStars(g.value)} ‚Ä¢ <span style="opacity:.75">x${qty}</span></span>
          </div>
        `;
      }else{
        fromPick.innerHTML = `
          <div class="pImg"><div class="fallback">‚ùî</div></div>
          <div class="info">
            <b>–ù–µ –≤—ã–±—Ä–∞–Ω</b>
            <span style="opacity:.75">–í—ã–±–µ—Ä–∏ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</span>
          </div>
        `;
      }

      if(upgradeTo){
        const g = getGift(upgradeTo);
        toPick.innerHTML = `
          <div class="pImg">${giftThumbHTML(g, 44)}</div>
          <div class="info">
            <b>${escapeHtml(g.name)}</b>
            <span><span class="star"></span>${formatStars(g.value)} ‚Ä¢ <span style="opacity:.75">—Ü–µ–ª—å</span></span>
          </div>
        `;
      }else{
        toPick.innerHTML = `
          <div class="pImg"><div class="fallback">üéØ</div></div>
          <div class="info">
            <b>–ù–µ –≤—ã–±—Ä–∞–Ω</b>
            <span style="opacity:.75">–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å</span>
          </div>
        `;
      }

      const chance = calcChance();
      setRingChance(chance);

      if(upgradeFrom && upgradeTo){
        upgradeHint.innerHTML = `–®–∞–Ω—Å: <b>${chance.toFixed(2)}%</b>. –ü–æ–ø–∞–¥–∏ —Å—Ç—Ä–µ–ª–∫–æ–π –Ω–∞ <b>—Å–∏–Ω—é—é</b> –ø–æ–ª–æ—Å—É.`;
        btnUpgrade.disabled = false;
      }else{
        upgradeHint.innerHTML = `–í—ã–±–µ—Ä–∏ <b>–∏—Å—Ö–æ–¥–Ω—ã–π</b> –ø–æ–¥–∞—Ä–æ–∫ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏ <b>—Ü–µ–ª—å</b>.`;
        btnUpgrade.disabled = true;
      }
    }

    function calcChance(){
      if(!upgradeFrom || !upgradeTo) return 0;
      const a = getGift(upgradeFrom).value;
      const b = getGift(upgradeTo).value;
      if(b <= 0) return 0;

      let raw = (a / b) * 100;
      raw *= UPGRADE_EDGE;
      raw = clamp(raw, 1.2, 95);

      if(a >= b){
        raw = clamp(88 + (a-b)/b*8, 88, 97);
      }
      return raw;
    }

    function setRingChance(percent){
      chanceText.textContent = `${percent.toFixed(2)}%`;

      const winDeg = clamp(percent, 1.2, 95) * 3.6;

      // –º–∞—Å–∫–∞ conic-gradient: —á–µ—Ä–Ω–æ–µ = –≤–∏–¥–Ω–æ, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ = —Å–∫—Ä—ã—Ç–æ
      // WIN –¥—É–≥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É (0deg)
      winArc.style.webkitMask = `conic-gradient(#000 0deg, #000 ${winDeg}deg, transparent ${winDeg}deg 360deg)`;
      winArc.style.mask = `conic-gradient(#000 0deg, #000 ${winDeg}deg, transparent ${winDeg}deg 360deg)`;

      // —á—É—Ç—å –º–µ–Ω—è–µ–º —è—Ä–∫–æ—Å—Ç—å –ø–æ —à–∞–Ω—Å—É
      const o = clamp(0.25 + percent/100 * 0.55, 0.25, 0.85);
      winArc.style.opacity = o;
    }

    /********************
     * Picker
     ********************/
    function openPickerFromInventory(){
      const list = Object.entries(inventory).filter(([id,qty])=>qty>0);
      if(list.length===0){
        showToast("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç");
        setTab("home", 0);
        return;
      }

      pickerTitle.textContent = "–í—ã–±–µ—Ä–∏ –∏—Å—Ö–æ–¥–Ω—ã–π";
      pickerBody.innerHTML = "";
      list
        .map(([id,qty])=>({ ...getGift(id), qty }))
        .sort((a,b)=>b.value-a.value)
        .forEach(g=>{
          const el = document.createElement("div");
          el.className = "pickCard";
          el.innerHTML = `
            <div class="row">
              <div class="pImg">${giftThumbHTML(g, 40)}</div>
              <div class="pr">x${g.qty}</div>
            </div>
            <div class="nm">${escapeHtml(g.name)}</div>
            <div class="sub"><span class="star"></span>${formatStars(g.value)}</div>
          `;
          el.addEventListener("click", ()=>{
            upgradeFrom = g.id;
            closePicker();
            renderUpgrade();
            pulse("#slotFrom");
          });
          pickerBody.appendChild(el);
        });

      showOverlay(pickerOverlay);
      gsap.fromTo(pickerOverlay.querySelector(".modal"), {y:20, opacity:0}, {y:0, opacity:1, duration:.20, ease:"power2.out"});
    }

    function openPickerFromCatalog(){
      pickerTitle.textContent = "–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å";
      pickerBody.innerHTML = "";
      GIFTS
        .slice()
        .sort((a,b)=>b.value-a.value)
        .forEach(g=>{
          const el = document.createElement("div");
          el.className = "pickCard";
          el.innerHTML = `
            <div class="row">
              <div class="pImg">${giftThumbHTML(g, 40)}</div>
              <div class="pr"><span class="star"></span>${formatStars(g.value)}</div>
            </div>
            <div class="nm">${escapeHtml(g.name)}</div>
            <div class="sub">id: ${escapeHtml(g.id)}</div>
          `;
          el.addEventListener("click", ()=>{
            upgradeTo = g.id;
            closePicker();
            renderUpgrade();
            pulse("#slotTo");
          });
          pickerBody.appendChild(el);
        });

      showOverlay(pickerOverlay);
      gsap.fromTo(pickerOverlay.querySelector(".modal"), {y:20, opacity:0}, {y:0, opacity:1, duration:.20, ease:"power2.out"});
    }

    function closePicker(){
      hideOverlay(pickerOverlay);
    }
    pickerClose.addEventListener("click", closePicker);
    pickerOverlay.addEventListener("click", (e)=>{ if(e.target === pickerOverlay) closePicker(); });

    /********************
     * Contents modal
     ********************/
    function openContentsModal(caseObj){
      contentsTitle.textContent = `${caseObj.title}`.toUpperCase();
      contentsList.innerHTML = "";

      // —Å–æ—Ä—Ç: –¥–æ—Ä–æ–≥–∏–µ —Å–≤–µ—Ä—Ö—É
      const items = caseObj.pool
        .map(p=>({ p, g: getGift(p.gift) }))
        .sort((a,b)=> b.g.value - a.g.value);

      items.forEach(({p,g})=>{
        const row = document.createElement("div");
        row.className = "rowItem";
        row.innerHTML = `
          <div class="rowLeft">
            <div class="thumb">${giftThumbHTML(g, 38)}</div>
            <div style="min-width:0">
              <b>${escapeHtml(g.name)}</b>
              <span><span class="star"></span>${formatStars(g.value)}</span>
            </div>
          </div>
          <div class="wBadge">w: ${Math.round(p.w)}</div>
        `;
        contentsList.appendChild(row);
      });

      showOverlay(contentsModal);
      gsap.fromTo(contentsModal.querySelector(".modal"), {y:20, opacity:0}, {y:0, opacity:1, duration:.20, ease:"power2.out"});
    }

    closeContents.addEventListener("click", ()=>hideOverlay(contentsModal));
    closeContentsBtn.addEventListener("click", ()=>hideOverlay(contentsModal));
    contentsModal.addEventListener("click", (e)=>{ if(e.target === contentsModal) hideOverlay(contentsModal); });

    /********************
     * Add stars modal (+)
     ********************/
    function openAddStarsModal(){
      // default 100
      setPresetActive(100);
      starsInput.value = "100";
      showOverlay(addStarsModal);
      gsap.fromTo(addStarsModal.querySelector(".modal"), {y:20, opacity:0}, {y:0, opacity:1, duration:.20, ease:"power2.out"});
    }

    function setPresetActive(v){
      [...presetRow.querySelectorAll(".preset")].forEach(p=>{
        p.classList.toggle("active", Number(p.dataset.v) === Number(v));
      });
    }

    presetRow.addEventListener("click", (e)=>{
      const btn = e.target.closest(".preset");
      if(!btn) return;
      const v = Number(btn.dataset.v || "0");
      if(!v) return;
      setPresetActive(v);
      starsInput.value = String(v);
      pulse("#presetRow");
    });

    btnApplyStars.addEventListener("click", ()=>{
      const v = Number(String(starsInput.value).replace(/[^\d.]/g,""));
      if(!Number.isFinite(v) || v <= 0){
        showToast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞");
        wiggle("#starsInput");
        return;
      }
      stars = round1(stars + v);
      saveNumber(STORAGE.stars, stars);
      renderStars();
      hideOverlay(addStarsModal);
      showToast(`+${formatStars(v)}‚òÖ`);
      pulse(".wallet");
    });

    closeAddStars.addEventListener("click", ()=>hideOverlay(addStarsModal));
    btnCancelStars.addEventListener("click", ()=>hideOverlay(addStarsModal));
    addStarsModal.addEventListener("click", (e)=>{ if(e.target === addStarsModal) hideOverlay(addStarsModal); });

    /********************
     * Helpers
     ********************/
    function getGift(id){
      return GIFTS.find(g=>g.id===id) || {id, name:"Unknown", emoji:"‚ùì", value:0, img:""};
    }

    function weightedPickWithEdge(pool){
      const gifts = pool.map(p=>getGift(p.gift));
      const minV = Math.min(...gifts.map(g=>g.value));
      const maxV = Math.max(...gifts.map(g=>g.value));

      const adjusted = pool.map(p=>{
        const g = getGift(p.gift);
        const t = (g.value - minV) / Math.max(1, (maxV - minV));
        const mult = lerp(CASE_EDGE_LOW_BOOST, 1/CASE_EDGE_LOW_BOOST, t);
        return { gift:p.gift, w: p.w * mult };
      });

      const sum = adjusted.reduce((s,p)=>s+p.w,0);
      let r = Math.random()*sum;
      for(const p of adjusted){
        r -= p.w;
        if(r <= 0) return p.gift;
      }
      return adjusted[adjusted.length-1].gift;
    }

    function renderStars(){ starsValue.textContent = formatStars(stars); }

    function formatStars(n){
      const x = Number(n);
      if(Number.isNaN(x)) return String(n);
      if(Math.abs(x - Math.round(x)) < 1e-9) return String(Math.round(x));
      return x.toFixed(1);
    }
    function round1(x){ return Math.round(x*10)/10; }

    function loadNumber(key, fallback){
      const v = localStorage.getItem(key);
      if(v===null || v===undefined) return fallback;
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function saveNumber(key, val){ localStorage.setItem(key, String(val)); }

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if(!v) return fallback;
        return JSON.parse(v);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function randFloat(a,b){ return a + Math.random()*(b-a); }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function gsapToPromise(target, vars){ return new Promise(res=> gsap.to(target, {...vars, onComplete: res}) ); }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    function pulse(selOrEl){
      const el = typeof selOrEl === "string" ? document.querySelector(selOrEl) : selOrEl;
      if(!el) return;
      gsap.fromTo(el, {scale:1}, {scale:1.015, duration:.14, yoyo:true, repeat:1, ease:"power2.out"});
    }
    function wiggle(sel){
      const el = document.querySelector(sel);
      if(!el) return;
      gsap.fromTo(el, {x:0}, {x:7, duration:.06, yoyo:true, repeat:5, ease:"power1.inOut"});
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      gsap.fromTo(toast, {y:10, opacity:0}, {y:0, opacity:1, duration:.18, ease:"power2.out"});
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{
        gsap.to(toast, {y:10, opacity:0, duration:.16, ease:"power2.in", onComplete:()=>toast.classList.remove("show")});
      }, 1600);
    }

    function giftThumbHTML(gift, size=42){
      const g = gift || {};
      if(g.img){
        return `<img src="${escapeAttr(g.img)}" alt="" style="width:${size}px;height:${size}px;object-fit:cover;display:block;">`;
      }
      return `<div class="fallback">${escapeHtml(g.emoji || "üéÅ")}</div>`;
    }

    function showOverlay(overlay){
      overlay.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function hideOverlay(overlay){
      const modal = overlay.querySelector(".modal");
      if(modal){
        gsap.to(modal, {y:20, opacity:0, duration:.14, ease:"power2.in", onComplete:()=>{
          overlay.classList.remove("show");
          gsap.set(modal, {clearProps:"all"});
          document.body.style.overflow = "";
        }});
      }else{
        overlay.classList.remove("show");
        document.body.style.overflow = "";
      }
    }
  </script>
</body>
</html>
